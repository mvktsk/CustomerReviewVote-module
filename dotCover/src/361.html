<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\data\sources\heineken-asia-pacific\hru-storefront-core\virtocommerce.storefront\domain\cart\cartbuilder.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.Extensions.Caching.Memory;
using VirtoCommerce.Storefront.Extensions;
using VirtoCommerce.Storefront.Model;
using VirtoCommerce.Storefront.Model.Caching;
using VirtoCommerce.Storefront.Model.Cart;
using VirtoCommerce.Storefront.Model.Cart.Services;
using VirtoCommerce.Storefront.Model.Cart.ValidationErrors;
using VirtoCommerce.Storefront.Model.Catalog;
using VirtoCommerce.Storefront.Model.Catalog.Specifications;
using VirtoCommerce.Storefront.Model.Common;
using VirtoCommerce.Storefront.Model.Common.Caching;
using VirtoCommerce.Storefront.Model.Common.Exceptions;
using VirtoCommerce.Storefront.Model.Marketing;
using VirtoCommerce.Storefront.Model.Marketing.Services;
using VirtoCommerce.Storefront.Model.Quote;
using VirtoCommerce.Storefront.Model.Security;
using VirtoCommerce.Storefront.Model.Services;
using VirtoCommerce.Storefront.Model.Stores;
using VirtoCommerce.Storefront.Model.Subscriptions.Services;
using VirtoCommerce.Storefront.Model.Tax.Services;

namespace VirtoCommerce.Storefront.Domain
{
    public class CartBuilder : ICartBuilder
    {
        private readonly IWorkContextAccessor _workContextAccessor;
        private readonly ICartService _cartService;
        private readonly ICatalogService _catalogService;
        private readonly IStorefrontMemoryCache _memoryCache;
        private readonly IPromotionEvaluator _promotionEvaluator;
        private readonly ITaxEvaluator _taxEvaluator;
        private readonly ISubscriptionService _subscriptionService;

        public CartBuilder(IWorkContextAccessor workContextAccessor, ICartService cartService, ICatalogService catalogSearchService,
            IStorefrontMemoryCache memoryCache, IPromotionEvaluator promotionEvaluator, ITaxEvaluator taxEvaluator, ISubscriptionService subscriptionService)
        {
            _cartService = cartService;
            _catalogService = catalogSearchService;
            _memoryCache = memoryCache;
            _workContextAccessor = workContextAccessor;
            _promotionEvaluator = promotionEvaluator;
            _taxEvaluator = taxEvaluator;
            _subscriptionService = subscriptionService;
        }

        #region ICartBuilder Members

        public virtual ShoppingCart Cart { get; private set; }

        public virtual async Task TakeCartAsync(ShoppingCart cart)
        {
            var store = _workContextAccessor.WorkContext.AllStores.FirstOrDefault(x =&gt; x.Id.EqualsInvariant(cart.StoreId));
            if (store == null)
            {
                throw new StorefrontException($&quot;{ nameof(cart.StoreId) } not found&quot;);
            }

            await FillChildObjectsAsync(cart, store);

            Cart = cart;
        }

        public void LoadOrCreateNewTransientCart(string cartName, Store store, User user, Language language, Currency currency, string type)
        {
            LoadOrCreateNewTransientCartAsync(cartName, store, user, language, currency, type).GetAwaiter().GetResult();
        }

        public virtual async Task LoadOrCreateNewTransientCartAsync(string cartName, Store store, User user, Language language, Currency currency, string type = null)
        {
            var cacheKey = CacheKey.With(GetType(), nameof(LoadOrCreateNewTransientCartAsync), store.Id, user.Contact?.Outlet?.Id, user.Id, currency.Code, type, cartName);
            Cart = await _memoryCache.GetOrCreateExclusiveAsync(cacheKey, async cacheEntry =&gt;
            {
                var cartSearchCriteria = CreateCartSearchCriteria(cartName, store, user, language, currency, type);
                var cartSearchResult = await _cartService.SearchCartsAsync(cartSearchCriteria);
                var cart = cartSearchResult.FirstOrDefault() ?? CreateCart(cartName, store, user, language, currency, type);

                //Add expiration token for concrete cart instance
                cacheEntry.AddExpirationToken(CartCacheRegion.CreateChangeToken(cart));

                await EvaluatePromotionsAsync(cart);
                await EvaluateTaxesAsync(cart, store);

                await FillChildObjectsAsync(cart, store);
                return cart;
            });
        }

        public virtual Task UpdateCartComment(string comment)
        {
            EnsureCartExists();

            Cart.Comment = comment;

            return Task.CompletedTask;
        }

        public virtual Task&lt;LineItem&gt; AddItemAsync(Product product, int quantity, bool isGift = false, string comment = null)
        {
            EnsureCartExists();

            return AddItemAsync(Cart, product, quantity, isGift, comment);
        }

        public virtual async Task&lt;LineItem&gt; AddItemAsync(ShoppingCart cart, Product product, int quantity, bool isGift = false, string comment = null)
        {
            LineItem result = null;

            var isProductAvailable = !_workContextAccessor.WorkContext.CurrentStore.CheckAvailability
                                     || new NonStandardGiftsIsInStockSpecification().IsSatisfiedBy(product)
                                     || new HapProductIsInStockSpecification().IsSatisfiedBy(product);
            if (isProductAvailable)
            {
                var lineItem = product.ToLineItem(cart.Language, quantity);
                lineItem.Product = product;
                lineItem.IsGift = isGift;
                lineItem.Comment = comment;

                result = await AddLineItemAsync(cart, lineItem);
            }

            return result;
        }

        public virtual async Task ChangeItemQuantityAsync(string id, int quantity)
        {
            EnsureCartExists();

            var lineItem = Cart.Items.FirstOrDefault(i =&gt; i.Id == id);
            if (lineItem != null)
            {
                await ChangeItemQuantityAsync(lineItem, quantity);
            }
        }

        public virtual async Task ChangeItemQuantityAsync(int lineItemIndex, int quantity)
        {
            EnsureCartExists();

            var lineItem = Cart.Items.ElementAt(lineItemIndex);
            if (lineItem != null)
            {
                await ChangeItemQuantityAsync(lineItem, quantity);
            }
        }

        public virtual async Task ChangeItemsQuantitiesAsync(int[] quantities)
        {
            EnsureCartExists();

            for (var i = 0; i &lt; quantities.Length; i++)
            {
                var lineItem = Cart.Items.ElementAt(i);
                if (lineItem != null &amp;&amp; quantities[i] &gt; 0)
                {
                    await ChangeItemQuantityAsync(lineItem, quantities[i]);
                }
            }
        }

        public virtual Task RemoveItemAsync(string id)
        {
            EnsureCartExists();

            var lineItem = Cart.Items.FirstOrDefault(x =&gt; x.Id == id);
            if (lineItem != null)
            {
                Cart.Items.Remove(lineItem);
            }

            return Task.FromResult((object)null);
        }

        public virtual Task AddCouponAsync(string couponCode)
        {
            EnsureCartExists();
            Cart.Coupon = new Coupon { Code = couponCode };
            return Task.FromResult((object)null);
        }

        public virtual Task RemoveCouponAsync()
        {
            EnsureCartExists();
            Cart.Coupon = null;
            return Task.FromResult((object)null);
        }

        public virtual Task ClearAsync()
        {
            EnsureCartExists();
            Cart.Items.Clear();
            return Task.FromResult((object)null);
        }

        public virtual async Task AddOrUpdateShipmentAsync(Shipment shipment)
        {
            EnsureCartExists();

            await RemoveExistingShipmentAsync(shipment);

            shipment.Currency = Cart.Currency;
            if (shipment.DeliveryAddress != null)
            {
                //Reset address key because it can equal a customer address from profile and if not do that it may cause
                //address primary key duplication error for multiple carts with the same address 
                shipment.DeliveryAddress.Key = null;
            }
            Cart.Shipments.Add(shipment);

            if (!string.IsNullOrEmpty(shipment.ShipmentMethodCode))
            {
                var availableShippingMethods = await GetAvailableShippingMethodsAsync();
                var shippingMethod = availableShippingMethods.FirstOrDefault(sm =&gt; shipment.ShipmentMethodCode.EqualsInvariant(sm.ShipmentMethodCode) &amp;&amp; shipment.ShipmentMethodOption.EqualsInvariant(sm.OptionName));
                if (shippingMethod == null)
                {
                    throw new Exception(string.Format(CultureInfo.InvariantCulture, &quot;Unknown shipment method: {0} with option: {1}&quot;, shipment.ShipmentMethodCode, shipment.ShipmentMethodOption));
                }
                shipment.Price = shippingMethod.Price;
                shipment.DiscountAmount = shippingMethod.DiscountAmount;
                shipment.TaxType = shippingMethod.TaxType;
            }
        }

        public virtual Task RemoveShipmentAsync(string shipmentId)
        {
            EnsureCartExists();

            var shipment = Cart.Shipments.FirstOrDefault(s =&gt; s.Id == shipmentId);
            if (shipment != null)
            {
                Cart.Shipments.Remove(shipment);
            }

            return Task.FromResult((object)null);
        }

        public virtual async Task AddOrUpdatePaymentAsync(Payment payment)
        {
            EnsureCartExists();

            await RemoveExistingPaymentAsync(payment);

            if (payment.BillingAddress != null)
            {
                //Reset address key because it can equal a customer address from profile and if not do that it may cause
                //address primary key duplication error for multiple carts with the same address 
                payment.BillingAddress.Key = null;
            }
            Cart.Payments.Add(payment);

            if (!string.IsNullOrEmpty(payment.PaymentGatewayCode))
            {
                var availablePaymentMethods = await GetAvailablePaymentMethodsAsync();
                var paymentMethod = availablePaymentMethods.FirstOrDefault(pm =&gt; string.Equals(pm.Code, payment.PaymentGatewayCode, StringComparison.InvariantCultureIgnoreCase));
                if (paymentMethod == null)
                {
                    throw new Exception(&quot;Unknown payment method &quot; + payment.PaymentGatewayCode);
                }
            }
        }

        public virtual async Task MergeWithCartAsync(ShoppingCart cart)
        {
            EnsureCartExists();

            //Reset primary keys for all aggregated entities before merge
            //To prevent insertions same Ids for target cart
            //exclude user because it might be the current one
            var entities = cart.GetFlatObjectsListWithInterface&lt;IEntity&gt;();
            foreach (var entity in entities.Where(x =&gt; !(x is User)).ToList())
            {
                entity.Id = null;
            }

            foreach (var lineItem in cart.Items)
            {
                await AddLineItemAsync(lineItem);
            }

            if (cart.Coupon != null)
            {
                Cart.Coupon = cart.Coupon;
            }

            foreach (var shipment in cart.Shipments)
            {
                await AddOrUpdateShipmentAsync(shipment);
            }

            foreach (var payment in cart.Payments)
            {
                await AddOrUpdatePaymentAsync(payment);
            }
        }

        public virtual async Task RemoveCartAsync()
        {
            EnsureCartExists();
            //Evict cart from cache
            CartCacheRegion.ExpireCart(Cart);
            await _cartService.DeleteCartByIdAsync(Cart.Id);
        }

        public virtual async Task FillFromQuoteRequestAsync(QuoteRequest quoteRequest)
        {
            EnsureCartExists();

            var productIds = quoteRequest.Items.Select(i =&gt; i.ProductId).ToArray();
            var products = await GetProductsAsync(productIds);

            Cart.Items.Clear();
            foreach (var product in products)
            {
                var quoteItem = quoteRequest.Items.FirstOrDefault(i =&gt; i.ProductId == product.Id);
                if (quoteItem != null)
                {
                    var lineItem = product.ToLineItem(Cart.Language, (int)quoteItem.SelectedTierPrice.Quantity);
                    lineItem.Product = product;
                    lineItem.ListPrice = quoteItem.ListPrice;
                    lineItem.SalePrice = quoteItem.SelectedTierPrice.Price;
                    if (lineItem.ListPrice &lt; lineItem.SalePrice)
                    {
                        lineItem.ListPrice = lineItem.SalePrice;
                    }
                    lineItem.DiscountAmount = lineItem.ListPrice - lineItem.SalePrice;
                    lineItem.IsReadOnly = true;
                    lineItem.Id = null;
                    Cart.Items.Add(lineItem);
                }
            }

            if (quoteRequest.RequestShippingQuote)
            {
                Cart.Shipments.Clear();
                var shipment = new Shipment(Cart.Currency);

                if (quoteRequest.ShippingAddress != null)
                {
                    shipment.DeliveryAddress = quoteRequest.ShippingAddress;
                }

                if (quoteRequest.ShipmentMethod != null)
                {
                    var availableShippingMethods = await GetAvailableShippingMethodsAsync();
                    var availableShippingMethod = availableShippingMethods?.FirstOrDefault(sm =&gt; sm.ShipmentMethodCode == quoteRequest.ShipmentMethod.ShipmentMethodCode);

                    if (availableShippingMethod != null)
                    {
                        shipment = quoteRequest.ShipmentMethod.ToCartShipment(Cart.Currency);
                    }
                }
                Cart.Shipments.Add(shipment);
            }

            var payment = new Payment(Cart.Currency)
            {
                Amount = quoteRequest.Totals.GrandTotalInclTax
            };

            if (quoteRequest.BillingAddress != null)
            {
                payment.BillingAddress = quoteRequest.BillingAddress;
            }

            Cart.Payments.Clear();
            Cart.Payments.Add(payment);
        }

        public virtual async Task&lt;IEnumerable&lt;ShippingMethod&gt;&gt; GetAvailableShippingMethodsAsync()
        {
            var workContext = _workContextAccessor.WorkContext;

            //Request available shipping rates 
            var retVal = (await _cartService.GetAvailableShippingMethodsAsync(Cart)).ToList();

            if (retVal.Any())
            {
                //Evaluate promotions cart and apply rewards for available shipping methods
                var promoEvalContext = Cart.ToPromotionEvaluationContext();
                await _promotionEvaluator.EvaluateDiscountsAsync(promoEvalContext, retVal);

                //Evaluate taxes for available shipping rates
                var taxEvalContext = Cart.ToTaxEvalContext(workContext.CurrentStore);
                taxEvalContext.Lines.Clear();
                taxEvalContext.Lines.AddRange(retVal.SelectMany(x =&gt; x.ToTaxLines()));
                await _taxEvaluator.EvaluateTaxesAsync(taxEvalContext, retVal);
            }

            return retVal;
        }

        public virtual async Task&lt;IEnumerable&lt;PaymentMethod&gt;&gt; GetAvailablePaymentMethodsAsync()
        {
            EnsureCartExists();

            var retVal = (await _cartService.GetAvailablePaymentMethodsAsync(Cart)).ToList();

            if (retVal.Any())
            {
                //Evaluate promotions cart and apply rewards for available shipping methods
                var promoEvalContext = Cart.ToPromotionEvaluationContext();
                await _promotionEvaluator.EvaluateDiscountsAsync(promoEvalContext, retVal);

                //Evaluate taxes for available payments 
                var workContext = _workContextAccessor.WorkContext;
                var taxEvalContext = Cart.ToTaxEvalContext(workContext.CurrentStore);
                taxEvalContext.Lines.Clear();
                taxEvalContext.Lines.AddRange(retVal.SelectMany(x =&gt; x.ToTaxLines()));
                await _taxEvaluator.EvaluateTaxesAsync(taxEvalContext, retVal);
            }

            return retVal;
        }

        public async Task ValidateAsync()
        {
            EnsureCartExists();
            await Task.WhenAll(ValidateCartItemsAsync(), ValidateCartShipmentsAsync());
            Cart.IsValid = Cart.Items.All(x =&gt; x.IsValid) &amp;&amp; Cart.Shipments.All(x =&gt; x.IsValid);
        }

        public virtual Task EvaluatePromotionsAsync()
        {
            EnsureCartExists();

            return EvaluatePromotionsAsync(Cart);
        }

        protected virtual async Task EvaluatePromotionsAsync(ShoppingCart cart)
        {
            RemoveGiftItems(cart);

            var isReadOnlyLineItems = cart.Items.Any(i =&gt; i.IsReadOnly);
            if (!isReadOnlyLineItems)
            {
                await FillProductsAsync(cart);

                //Get product inventory to fill InStockQuantity parameter of LineItem
                //required for some promotions evaluation

                foreach (var lineItem in cart.Items.Where(x =&gt; x.Product != null))
                {
                    lineItem.InStockQuantity = (int)lineItem.Product.AvailableQuantity;
                }

                var evalContext = cart.ToPromotionEvaluationContext();
                await _promotionEvaluator.EvaluateDiscountsAsync(evalContext, new IDiscountable[] { cart });

                if (cart.GiftRewards?.Any() == true)
                {
                    await AddGiftItems(cart);
                    CopyPromotionCodesToItemComments(cart);
                }
            }
        }

        public Task EvaluateTaxesAsync()
        {
            var store = _workContextAccessor.WorkContext.CurrentStore;
            return EvaluateTaxesAsync(Cart, store);
        }

        protected async Task EvaluateTaxesAsync(ShoppingCart cart, Store store)
        {
            await _taxEvaluator.EvaluateTaxesAsync(cart.ToTaxEvalContext(store), new[] { cart });
        }

        public virtual async Task SaveAsync()
        {
            EnsureCartExists();

            var cart = await _cartService.SaveChanges(Cart);

            //Evict cart from cache
            CartCacheRegion.ExpireCart(Cart);

            await TakeCartAsync(cart);
        }

        #endregion

        protected virtual void RemoveGiftItems(ShoppingCart cart)
        {
            var giftItems = cart.Items.Where(i =&gt; i.IsGift).ToList();
            foreach (var giftItem in giftItems)
            {
                cart.Items.Remove(giftItem);
            }
        }

        protected virtual async Task AddGiftItems(ShoppingCart cart)
        {
            var giftRewards = cart.GiftRewards
                ?.Where(r =&gt; r.IsValid &amp;&amp; r.Quantity &gt; 0 &amp;&amp; !string.IsNullOrEmpty(r.ProductId))
                .DistinctBy(r =&gt; r.ProductId) // Workaround to apply only one gift item for a shopping cart
                .ToList();

            if (giftRewards?.Any() == true)
            {
                var giftProductIds = giftRewards.Select(r =&gt; r.ProductId).Distinct(StringComparer.OrdinalIgnoreCase).ToArray();
                var giftProducts = await GetProductsAsync(giftProductIds);

                if (giftProducts.Any())
                {
                    // Set zero price
                    foreach (var giftProduct in giftProducts)
                    {
                        giftProduct.Price = new ProductPrice(cart.Currency) { ListPrice = new Money(0m, cart.Currency), SalePrice = new Money(0m, cart.Currency) };
                    }

                    foreach (var reward in giftRewards)
                    {
                        var giftProduct = giftProducts.FirstOrDefault(p =&gt; p.Id.EqualsInvariant(reward.ProductId));
                        if (giftProduct != null)
                        {
                            var giftLineItem = await AddItemAsync(cart, giftProduct, reward.Quantity, true);

                            if (giftLineItem != null)
                            {
                                giftLineItem.AddPromotionCode(reward);
                            }
                        }
                    }
                }
            }
        }

        private static void CopyPromotionCodesToItemComments(ShoppingCart cart)
        {
            // Add promotion codes to condition products
            foreach (var cartItem in cart.Items)
            {
                var conditionProductsWithPromotionCodes = cartItem.GetConditionProductsWithPromotionCodes();

                foreach (var conditionProductId in conditionProductsWithPromotionCodes.Keys)
                {
                    var conditionLineItem = cart.Items.FirstOrDefault(item =&gt; !item.IsGift &amp;&amp; item.ProductId.EqualsInvariant(conditionProductId));
                    if (conditionLineItem != null)
                    {
                        foreach (var promotionCode in conditionProductsWithPromotionCodes[conditionProductId])
                        {
                            conditionLineItem.AddPromotionCode(promotionCode);
                        }
                    }
                }
            }

            // Convert promotion codes to a comment
            foreach (var cartItem in cart.Items)
            {
                cartItem.CopyPromotionCodesToComment();
            }
        }

        protected virtual CartSearchCriteria CreateCartSearchCriteria(string cartName, Store store, User user, Language language, Currency currency, string type)
        {
            return new CartSearchCriteria
            {
                StoreId = store.Id,
                Customer = user,
                Name = cartName,
                Currency = currency,
                Type = type,
                OutletId = user.Contact?.Outlet?.Id
            };
        }

        protected virtual ShoppingCart CreateCart(string cartName, Store store, User user, Language language, Currency currency, string type)
        {
            var outlet = user.Contact?.Outlet;

            var cart = new ShoppingCart(currency, language)
            {
                CustomerId = user.Id,
                Name = cartName,
                StoreId = store.Id,
                OrganizationId = user.Contact?.Organization?.Id,
                OutletId = outlet?.Id,
                OutletDisId = outlet?.DynamicProperties?.GetDynamicPropertyValue(&quot;SalePointId&quot;),
                OutletName = outlet?.Name,
                Language = language,
                Customer = user,
                Type = type,
                IsAnonymous = !user.IsRegisteredUser,
                CustomerName = user.IsRegisteredUser ? user.UserName : SecurityConstants.AnonymousUsername
            };

            return cart;
        }

        protected virtual Task ValidateCartItemsAsync()
        {
            foreach (var lineItem in Cart.Items.ToList())
            {
                lineItem.ValidationErrors.Clear();

                if (lineItem.Product == null || !lineItem.Product.IsActive || !lineItem.Product.IsBuyable)
                {
                    lineItem.ValidationErrors.Add(new UnavailableError());
                    lineItem.IsValid = false;
                }
                else
                {
                    var isProductAvailable = !_workContextAccessor.WorkContext.CurrentStore.CheckAvailability || new HapProductIsInStockSpecification().IsSatisfiedBy(lineItem.Product);
                    if (!isProductAvailable)
                    {
                        lineItem.IsValid = false;

                        var availableQuantity = lineItem.Product.AvailableQuantity;
                        lineItem.ValidationErrors.Add(new QuantityError(availableQuantity));
                    }

                    if (!lineItem.IsGift)
                    {
                        var tierPrice = lineItem.Product.Price.GetTierPrice(lineItem.Quantity);
                        if (tierPrice.Price &gt; lineItem.SalePrice)
                        {
                            lineItem.ValidationErrors.Add(new PriceError(lineItem.SalePrice, lineItem.SalePriceWithTax, tierPrice.Price, tierPrice.PriceWithTax));
                        }
                    }
                }
            }
            return Task.CompletedTask;
        }

        protected virtual async Task ValidateCartShipmentsAsync()
        {
            foreach (var shipment in Cart.Shipments.ToArray())
            {
                shipment.ValidationErrors.Clear();

                var availShippingmethods = await GetAvailableShippingMethodsAsync();
                var shipmentShippingMethod = availShippingmethods.FirstOrDefault(sm =&gt; shipment.HasSameMethod(sm));
                if (shipmentShippingMethod == null)
                {
                    shipment.ValidationErrors.Add(new UnavailableError());
                }
                else if (shipmentShippingMethod.Price != shipment.Price)
                {
                    shipment.ValidationErrors.Add(new PriceError(shipment.Price, shipment.PriceWithTax, shipmentShippingMethod.Price, shipmentShippingMethod.PriceWithTax));
                }
            }
        }

        protected virtual Task RemoveExistingPaymentAsync(Payment payment)
        {
            if (payment != null)
            {
                var existingPayment = !payment.IsTransient() ? Cart.Payments.FirstOrDefault(s =&gt; s.Id == payment.Id) : null;
                if (existingPayment != null)
                {
                    Cart.Payments.Remove(existingPayment);
                }
            }

            return Task.FromResult((object)null);
        }

        protected virtual Task RemoveExistingShipmentAsync(Shipment shipment)
        {
            if (shipment != null)
            {
                var existShipment = !shipment.IsTransient() ? Cart.Shipments.FirstOrDefault(s =&gt; s.Id == shipment.Id) : null;
                if (existShipment != null)
                {
                    Cart.Shipments.Remove(existShipment);
                }
            }

            return Task.FromResult((object)null);
        }

        protected virtual Task&lt;LineItem&gt; AddLineItemAsync(LineItem lineItem)
        {
            return AddLineItemAsync(Cart, lineItem);
        }

        protected virtual async Task&lt;LineItem&gt; AddLineItemAsync(ShoppingCart cart, LineItem lineItem)
        {
            LineItem result;

            var existingLineItem = cart.Items.FirstOrDefault(li =&gt; li.ProductId == lineItem.ProductId &amp;&amp; li.IsGift == lineItem.IsGift);
            if (existingLineItem != null)
            {
                result = await ChangeItemQuantityAsync(existingLineItem, existingLineItem.Quantity + Math.Max(1, lineItem.Quantity));
            }
            else
            {
                lineItem.Id = null;
                cart.Items.Add(lineItem);
                result = lineItem;
            }

            return result;
        }

        protected virtual Task&lt;LineItem&gt; ChangeItemQuantityAsync(LineItem lineItem, int quantity)
        {
            return ChangeItemQuantityAsync(Cart, lineItem, quantity);
        }

        protected virtual Task&lt;LineItem&gt; ChangeItemQuantityAsync(ShoppingCart cart, LineItem lineItem, int quantity)
        {
            var result = lineItem;

            if (lineItem != null &amp;&amp; !lineItem.IsReadOnly)
            {
                if (lineItem.Product != null)
                {
                    lineItem.SalePrice = lineItem.Product.Price.GetTierPrice(quantity).Price;
                    //List price should be always greater ot equals sale price because it may cause incorrect totals calculation
                    if (lineItem.ListPrice &lt; lineItem.SalePrice)
                    {
                        lineItem.ListPrice = lineItem.SalePrice;
                    }
                }

                if (quantity &gt; 0)
                {
                    lineItem.Quantity = quantity;
                }
                else
                {
                    cart.Items.Remove(lineItem);
                    result = null;
                }
            }

            return Task.FromResult(result);
        }

        protected virtual void EnsureCartExists()
        {
            if (Cart == null)
            {
                throw new StorefrontException(&quot;Cart not loaded.&quot;);
            }
        }

        private async Task FillChildObjectsAsync(ShoppingCart cart, Store store)
        {
            if (cart == null)
            {
                throw new ArgumentNullException(nameof(cart));
            }

            await Task.WhenAll(FillProductsAsync(cart), FillPaymentPlans(cart, store));

            cart.Items = cart.Items
                .OrderBy(i =&gt; i.IsGift)
                .ThenBy(i =&gt; i.Name)
                .ThenBy(i =&gt; i.Sku)
                .ToList();
        }

        private async Task FillProductsAsync(ShoppingCart cart)
        {
            var itemsWithoutProduct = cart.Items
                .Where(i =&gt; i.Product == null)
                .ToList();

            if (itemsWithoutProduct.Any())
            {
                var productIds = itemsWithoutProduct
                    .Select(i =&gt; i.ProductId)
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .ToArray();

                var products = await GetProductsAsync(productIds);
                foreach (var item in itemsWithoutProduct)
                {
                    item.Product = products.FirstOrDefault(x =&gt; x.Id.EqualsInvariant(item.ProductId));
                }
            }
        }

        private async Task FillPaymentPlans(ShoppingCart cart, Store store)
        {
            if (store.SubscriptionEnabled)
            {
                var itemsWithoutPaymentPlan = cart.Items
                    .Where(i =&gt; i.PaymentPlan == null)
                    .ToList();

                var paymentPlanIds = itemsWithoutPaymentPlan
                    .Select(i =&gt; i.ProductId)
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .ToList();

                if (cart.PaymentPlan == null)
                {
                    paymentPlanIds.Add(cart.Id);
                }

                if (paymentPlanIds.Any())
                {
                    var paymentPlans = await _subscriptionService.GetPaymentPlansByIdsAsync(paymentPlanIds.ToArray());

                    if (cart.PaymentPlan == null)
                    {
                        cart.PaymentPlan = paymentPlans.FirstOrDefault(x =&gt; x.Id == cart.Id);
                    }

                    foreach (var item in itemsWithoutPaymentPlan)
                    {
                        item.PaymentPlan = paymentPlans.FirstOrDefault(x =&gt; x.Id == item.ProductId);
                    }
                }
            }
        }

        private async Task&lt;IList&lt;Product&gt;&gt; GetProductsAsync(string[] productIds)
        {
            var products = await _catalogService.GetProductsAsync(productIds, ItemResponseGroup.ItemProperties | ItemResponseGroup.Inventory | ItemResponseGroup.ItemWithPrices | ItemResponseGroup.ItemWithDiscounts);
            return products;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[39,9,40,158,0],[41,9,41,10,0],[42,13,42,40,0],[43,13,43,52,0],[44,13,44,40,0],[45,13,45,56,0],[46,13,46,54,0],[47,13,47,42,0],[48,13,48,56,0],[49,9,49,10,0],[53,44,53,48,0],[53,49,53,61,0],[56,9,56,10,0],[57,13,57,124,0],[57,88,57,122,0],[58,13,58,31,0],[59,13,59,14,0],[60,17,60,86,0],[63,13,63,54,0],[65,13,65,25,0],[66,9,66,10,0],[69,9,69,10,0],[70,13,70,121,0],[71,9,71,10,0],[74,9,74,10,0],[75,13,75,172,0],[76,13,90,16,0],[77,13,77,14,0],[78,17,78,116,0],[79,17,79,96,0],[80,17,80,125,0],[83,17,83,88,0],[85,17,85,53,0],[86,17,86,55,0],[88,17,88,58,0],[89,17,89,29,0],[90,13,90,14,0],[91,9,91,10,0],[94,9,94,10,0],[95,13,95,32,0],[97,13,97,36,0],[99,13,99,39,0],[100,9,100,10,0],[103,9,103,10,0],[104,13,104,32,0],[106,13,106,75,0],[107,9,107,10,0],[110,9,110,10,0],[111,13,111,36,0],[113,13,115,103,0],[116,13,116,36,0],[117,13,117,14,0],[118,17,118,76,0],[119,17,119,44,0],[120,17,120,42,0],[121,17,121,44,0],[123,17,123,65,0],[124,13,124,14,0],[126,13,126,27,0],[127,9,127,10,0],[130,9,130,10,0],[131,13,131,32,0],[133,13,133,71,0],[133,59,133,69,0],[134,13,134,34,0],[135,13,135,14,0],[136,17,136,67,0],[137,13,137,14,0],[138,9,138,10,0],[141,9,141,10,0],[142,13,142,32,0],[144,13,144,64,0],[145,13,145,34,0],[146,13,146,14,0],[147,17,147,67,0],[148,13,148,14,0],[149,9,149,10,0],[152,9,152,10,0],[153,13,153,32,0],[155,18,155,27,0],[155,29,155,50,0],[155,52,155,55,0],[156,13,156,14,0],[157,17,157,56,0],[158,17,158,59,0],[159,17,159,18,0],[160,21,160,76,0],[161,17,161,18,0],[162,13,162,14,0],[163,9,163,10,0],[166,9,166,10,0],[167,13,167,32,0],[169,13,169,71,0],[169,59,169,69,0],[170,13,170,34,0],[171,13,171,14,0],[172,17,172,45,0],[173,13,173,14,0],[175,13,175,50,0],[176,9,176,10,0],[179,9,179,10,0],[180,13,180,32,0],[181,13,181,60,0],[182,13,182,50,0],[183,9,183,10,0],[186,9,186,10,0],[187,13,187,32,0],[188,13,188,32,0],[189,13,189,50,0],[190,9,190,10,0],[193,9,193,10,0],[194,13,194,32,0],[195,13,195,32,0],[196,13,196,50,0],[197,9,197,10,0],[200,9,200,10,0],[201,13,201,32,0],[203,13,203,57,0],[205,13,205,47,0],[206,13,206,50,0],[207,13,207,14,0],[210,17,210,53,0],[211,13,211,14,0],[212,13,212,42,0],[214,13,214,68,0],[215,13,215,14,0],[216,17,216,89,0],[217,17,217,216,0],[217,84,217,214,0],[218,17,218,44,0],[219,17,219,18,0],[220,21,220,195,0],[222,17,222,55,0],[223,17,223,73,0],[224,17,224,59,0],[225,13,225,14,0],[226,9,226,10,0],[229,9,229,10,0],[230,13,230,32,0],[232,13,232,83,0],[232,63,232,81,0],[233,13,233,34,0],[234,13,234,14,0],[235,17,235,49,0],[236,13,236,14,0],[238,13,238,50,0],[239,9,239,10,0],[242,9,242,10,0],[243,13,243,32,0],[245,13,245,55,0],[247,13,247,48,0],[248,13,248,14,0],[251,17,251,51,0],[252,13,252,14,0],[253,13,253,40,0],[255,13,255,67,0],[256,13,256,14,0],[257,17,257,87,0],[258,17,258,179,0],[258,82,258,177,0],[259,17,259,43,0],[260,17,260,18,0],[261,21,261,97,0],[263,13,263,14,0],[264,9,264,10,0],[267,9,267,10,0],[268,13,268,32,0],[273,13,273,76,0],[274,13,274,20,0],[274,22,274,32,0],[274,33,274,35,0],[274,36,274,78,0],[274,56,274,68,0],[275,13,275,14,0],[276,17,276,34,0],[277,13,277,14,0],[279,13,279,20,0],[279,22,279,34,0],[279,35,279,37,0],[279,38,279,48,0],[280,13,280,14,0],[281,17,281,50,0],[282,13,282,14,0],[284,13,284,37,0],[285,13,285,14,0],[286,17,286,43,0],[287,13,287,14,0],[289,13,289,20,0],[289,22,289,34,0],[289,35,289,37,0],[289,38,289,52,0],[290,13,290,14,0],[291,17,291,58,0],[292,13,292,14,0],[294,13,294,20,0],[294,22,294,33,0],[294,34,294,36,0],[294,37,294,50,0],[295,13,295,14,0],[296,17,296,56,0],[297,13,297,14,0],[298,9,298,10,0],[301,9,301,10,0],[302,13,302,32,0],[304,13,304,46,0],[305,13,305,61,0],[306,9,306,10,0],[309,9,309,10,0],[310,13,310,32,0],[312,13,312,84,0],[312,61,312,72,0],[313,13,313,63,0],[315,13,315,32,0],[316,13,316,20,0],[316,22,316,33,0],[316,34,316,36,0],[316,37,316,45,0],[317,13,317,14,0],[318,17,318,99,0],[318,72,318,97,0],[319,17,319,39,0],[320,17,320,18,0],[321,21,321,113,0],[322,21,322,48,0],[323,21,323,62,0],[324,21,324,76,0],[325,21,325,65,0],[326,21,326,22,0],[327,25,327,65,0],[328,21,328,22,0],[329,21,329,87,0],[330,21,330,48,0],[331,21,331,40,0],[332,21,332,46,0],[333,17,333,18,0],[334,13,334,14,0],[336,13,336,51,0],[337,13,337,14,0],[338,17,338,40,0],[339,17,339,60,0],[341,17,341,58,0],[342,17,342,18,0],[343,21,343,77,0],[344,17,344,18,0],[346,17,346,57,0],[347,17,347,18,0],[348,21,348,93,0],[349,21,349,171,0],[349,98,349,169,0],[351,21,351,57,0],[352,21,352,22,0],[353,25,353,94,0],[354,21,354,22,0],[355,17,355,18,0],[356,17,356,46,0],[357,13,357,14,0],[359,13,362,15,0],[364,13,364,53,0],[365,13,365,14,0],[366,17,366,70,0],[367,13,367,14,0],[369,13,369,35,0],[370,13,370,40,0],[371,9,371,10,0],[374,9,374,10,0],[375,13,375,64,0],[378,13,378,95,0],[380,13,380,30,0],[381,13,381,14,0],[383,17,383,76,0],[384,17,384,92,0],[387,17,387,86,0],[388,17,388,46,0],[389,17,389,87,0],[389,70,389,84,0],[390,17,390,80,0],[391,13,391,14,0],[393,13,393,27,0],[394,9,394,10,0],[397,9,397,10,0],[398,13,398,32,0],[400,13,400,94,0],[402,13,402,30,0],[403,13,403,14,0],[405,17,405,76,0],[406,17,406,92,0],[409,17,409,68,0],[410,17,410,86,0],[411,17,411,46,0],[412,17,412,87,0],[412,70,412,84,0],[413,17,413,80,0],[414,13,414,14,0],[416,13,416,27,0],[417,9,417,10,0],[420,9,420,10,0],[421,13,421,32,0],[422,13,422,88,0],[423,13,423,97,0],[423,48,423,57,0],[423,86,423,95,0],[424,9,424,10,0],[427,9,427,10,0],[428,13,428,32,0],[430,13,430,50,0],[431,9,431,10,0],[434,9,434,10,0],[435,13,435,35,0],[437,13,437,73,0],[437,59,437,71,0],[438,13,438,38,0],[439,13,439,14,0],[440,17,440,47,0],[445,17,445,24,0],[445,26,445,38,0],[445,39,445,41,0],[445,42,445,82,0],[445,64,445,81,0],[446,17,446,18,0],[447,21,447,88,0],[448,17,448,18,0],[450,17,450,71,0],[451,17,451,109,0],[453,17,453,53,0],[454,17,454,18,0],[455,21,455,46,0],[456,21,456,60,0],[457,17,457,18,0],[458,13,458,14,0],[459,9,459,10,0],[462,9,462,10,0],[463,13,463,71,0],[464,13,464,52,0],[465,9,465,10,0],[468,9,468,10,0],[469,13,469,98,0],[470,9,470,10,0],[473,9,473,10,0],[474,13,474,32,0],[476,13,476,61,0],[479,13,479,46,0],[481,13,481,39,0],[482,9,482,10,0],[487,9,487,10,0],[488,13,488,70,0],[488,51,488,59,0],[489,13,489,20,0],[489,22,489,34,0],[489,35,489,37,0],[489,38,489,47,0],[490,13,490,14,0],[491,17,491,45,0],[492,13,492,14,0],[493,9,493,10,0],[496,9,496,10,0],[497,13,500,27,0],[498,30,498,95,0],[499,34,499,45,0],[502,13,502,44,0],[503,13,503,14,0],[504,17,504,128,0],[504,62,504,73,0],[505,17,505,75,0],[507,17,507,40,0],[508,17,508,18,0],[510,21,510,28,0],[510,30,510,45,0],[510,46,510,48,0],[510,49,510,61,0],[511,21,511,22,0],[512,25,512,164,0],[513,21,513,22,0],[515,21,515,28,0],[515,30,515,40,0],[515,41,515,43,0],[515,44,515,55,0],[516,21,516,22,0],[517,25,517,116,0],[517,76,517,114,0],[518,25,518,49,0],[519,25,519,26,0],[520,29,520,109,0],[522,29,522,54,0],[523,29,523,30,0],[524,33,524,71,0],[525,29,525,30,0],[526,25,526,26,0],[527,21,527,22,0],[528,17,528,18,0],[529,13,529,14,0],[530,9,530,10,0],[533,9,533,10,0],[535,13,535,20,0],[535,22,535,34,0],[535,35,535,37,0],[535,38,535,48,0],[536,13,536,14,0],[537,17,537,109,0],[539,17,539,24,0],[539,26,539,48,0],[539,49,539,51,0],[539,52,539,92,0],[540,17,540,18,0],[541,21,541,147,0],[541,79,541,145,0],[542,21,542,51,0],[543,21,543,22,0],[544,25,544,32,0],[544,34,544,51,0],[544,52,544,54,0],[544,55,544,110,0],[545,25,545,26,0],[546,29,546,79,0],[547,25,547,26,0],[548,21,548,22,0],[549,17,549,18,0],[550,13,550,14,0],[553,13,553,20,0],[553,22,553,34,0],[553,35,553,37,0],[553,38,553,48,0],[554,13,554,14,0],[555,17,555,56,0],[556,13,556,14,0],[557,9,557,10,0],[560,9,560,10,0],[561,13,569,15,0],[570,9,570,10,0],[573,9,573,10,0],[574,13,574,47,0],[576,13,590,15,0],[592,13,592,25,0],[593,9,593,10,0],[596,9,596,10,0],[597,13,597,20,0],[597,22,597,34,0],[597,35,597,37,0],[597,38,597,57,0],[598,13,598,14,0],[599,17,599,51,0],[601,17,601,107,0],[602,17,602,18,0],[603,21,603,75,0],[604,21,604,46,0],[605,17,605,18,0],[607,17,607,18,0],[608,21,608,185,0],[609,21,609,45,0],[610,21,610,22,0],[611,25,611,50,0],[613,25,613,84,0],[614,25,614,93,0],[615,21,615,22,0],[617,21,617,42,0],[618,21,618,22,0],[619,25,619,96,0],[620,25,620,66,0],[621,25,621,26,0],[622,29,622,163,0],[623,25,623,26,0],[624,21,624,22,0],[625,17,625,18,0],[626,13,626,14,0],[627,13,627,39,0],[628,9,628,10,0],[631,9,631,10,0],[632,13,632,20,0],[632,22,632,34,0],[632,35,632,37,0],[632,38,632,62,0],[633,13,633,14,0],[634,17,634,51,0],[636,17,636,85,0],[637,17,637,116,0],[637,88,637,114,0],[638,17,638,52,0],[639,17,639,18,0],[640,21,640,75,0],[641,17,641,18,0],[642,22,642,73,0],[643,17,643,18,0],[644,21,644,173,0],[645,17,645,18,0],[646,13,646,14,0],[647,9,647,10,0],[650,9,650,10,0],[651,13,651,33,0],[652,13,652,14,0],[653,17,653,125,0],[653,98,653,116,0],[654,17,654,45,0],[655,17,655,18,0],[656,21,656,59,0],[657,17,657,18,0],[658,13,658,14,0],[660,13,660,50,0],[661,9,661,10,0],[664,9,664,10,0],[665,13,665,34,0],[666,13,666,14,0],[667,17,667,126,0],[667,98,667,117,0],[668,17,668,43,0],[669,17,669,18,0],[670,21,670,58,0],[671,17,671,18,0],[672,13,672,14,0],[674,13,674,50,0],[675,9,675,10,0],[678,9,678,10,0],[679,13,679,53,0],[680,9,680,10,0],[683,9,683,10,0],[686,13,686,136,0],[686,68,686,134,0],[687,13,687,42,0],[688,13,688,14,0],[689,17,689,134,0],[690,13,690,14,0],[692,13,692,14,0],[693,17,693,36,0],[694,17,694,42,0],[695,17,695,35,0],[696,13,696,14,0],[698,13,698,27,0],[699,9,699,10,0],[702,9,702,10,0],[703,13,703,70,0],[704,9,704,10,0],[707,9,707,10,0],[708,13,708,35,0],[710,13,710,58,0],[711,13,711,14,0],[712,17,712,46,0],[713,17,713,18,0],[714,21,714,94,0],[716,21,716,65,0],[717,21,717,22,0],[718,25,718,65,0],[719,21,719,22,0],[720,17,720,18,0],[722,17,722,34,0],[723,17,723,18,0],[724,21,724,50,0],[725,17,725,18,0],[727,17,727,18,0],[728,21,728,49,0],[729,21,729,35,0],[730,17,730,18,0],[731,13,731,14,0],[733,13,733,44,0],[734,9,734,10,0],[737,9,737,10,0],[738,13,738,30,0],[739,13,739,14,0],[740,17,740,67,0],[742,9,742,10,0],[745,9,745,10,0],[746,13,746,30,0],[747,13,747,14,0],[748,17,748,63,0],[751,13,751,88,0],[753,13,757,27,0],[754,31,754,39,0],[755,30,755,36,0],[756,30,756,35,0],[758,9,758,10,0],[761,9,761,10,0],[762,13,764,27,0],[763,29,763,46,0],[766,13,766,43,0],[767,13,767,14,0],[768,17,771,32,0],[769,34,769,45,0],[773,17,773,67,0],[774,17,774,24,0],[774,26,774,34,0],[774,35,774,37,0],[774,38,774,57,0],[775,17,775,18,0],[776,21,776,103,0],[776,65,776,101,0],[777,17,777,18,0],[778,13,778,14,0],[779,9,779,10,0],[782,9,782,10,0],[783,13,783,43,0],[784,13,784,14,0],[785,17,787,31,0],[786,33,786,54,0],[789,17,792,31,0],[790,34,790,45,0],[794,17,794,46,0],[795,17,795,18,0],[796,21,796,49,0],[797,17,797,18,0],[799,17,799,42,0],[800,17,800,18,0],[801,21,801,119,0],[803,21,803,50,0],[804,21,804,22,0],[805,25,805,94,0],[805,77,805,92,0],[806,21,806,22,0],[808,21,808,28,0],[808,30,808,38,0],[808,39,808,41,0],[808,42,808,65,0],[809,21,809,22,0],[810,25,810,101,0],[810,77,810,99,0],[811,21,811,22,0],[812,17,812,18,0],[813,13,813,14,0],[814,9,814,10,0],[817,9,817,10,0],[818,13,818,216,0],[819,13,819,29,0],[820,9,820,10,0]]);
    </script>
  </body>
</html>