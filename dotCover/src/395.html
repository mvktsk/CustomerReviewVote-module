<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\data\sources\heineken-asia-pacific\hru-storefront-core\virtocommerce.storefront\domain\order\orderconverter.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using VirtoCommerce.Storefront.Common;
using VirtoCommerce.Storefront.Domain.Distributors;
using VirtoCommerce.Storefront.Model;
using VirtoCommerce.Storefront.Model.Catalog;
using VirtoCommerce.Storefront.Model.Common;
using VirtoCommerce.Storefront.Model.Marketing;
using VirtoCommerce.Storefront.Model.Order;
using coreDto = VirtoCommerce.Storefront.AutoRestClients.CoreModuleApi.Models;
using orderDto = VirtoCommerce.Storefront.AutoRestClients.OrdersModuleApi.Models;
using platformDto = VirtoCommerce.Storefront.AutoRestClients.PlatformModuleApi.Models;
using storeDto = VirtoCommerce.Storefront.AutoRestClients.StoreModuleApi.Models;

namespace VirtoCommerce.Storefront.Domain
{

    public static partial class OrderConverter
    {
        public static orderDto.CustomerOrderSearchCriteria ToSearchCriteriaDto(this OrderSearchCriteria criteria)
        {
            var result = new orderDto.CustomerOrderSearchCriteria
            {
                ResponseGroup = ((int)criteria.ResponseGroup).ToString(),
                CustomerId = criteria.CustomerId,
                StartDate = criteria.StartDate,
                EndDate = criteria.EndDate,
                Statuses = criteria.Statuses?.ToList(),
                StoreIds = criteria.StoreIds?.ToList(),

                Sort = criteria.Sort,
                Skip = criteria.Start,
                Take = criteria.PageSize,
                OutletIds = criteria.OutletIds
            };

            return result;
        }

        public static DynamicProperty ToDynamicProperty(this orderDto.DynamicObjectProperty propertyDto)
        {
            return propertyDto.JsonConvert&lt;coreDto.DynamicObjectProperty&gt;().ToDynamicProperty();
        }

        public static orderDto.DynamicObjectProperty ToOrderDynamicPropertyDto(this DynamicProperty property)
        {
            return property.ToDynamicPropertyDto().JsonConvert&lt;orderDto.DynamicObjectProperty&gt;();
        }

        public static orderDto.Address ToOrderAddressDto(this Address address)
        {
            return address.ToCoreAddressDto().JsonConvert&lt;orderDto.Address&gt;();
        }

        public static Address ToAddress(this orderDto.Address addressDto)
        {
            return addressDto.JsonConvert&lt;coreDto.Address&gt;().ToAddress();
        }

        public static ShipmentPackage ToShipmentPackage(this orderDto.ShipmentPackage shipmentPackageDto, IEnumerable&lt;Currency&gt; currencies, Language language)
        {
            var result = new ShipmentPackage
            {
                BarCode = shipmentPackageDto.BarCode,
                Id = shipmentPackageDto.Id,

                Height = shipmentPackageDto.Height,
                Weight = shipmentPackageDto.Weight,
                Length = shipmentPackageDto.Length,
                Width = shipmentPackageDto.Width,
                WeightUnit = shipmentPackageDto.WeightUnit,
                MeasureUnit = shipmentPackageDto.MeasureUnit
            };

            if (shipmentPackageDto.Items != null)
            {
                result.Items = shipmentPackageDto.Items.Select(i =&gt; ToShipmentItem(i, currencies, language)).ToList();
            }

            return result;
        }

        public static ShipmentItem ToShipmentItem(this orderDto.ShipmentItem shipmentItemDto, IEnumerable&lt;Currency&gt; availCurrencies, Language language)
        {
            var result = new ShipmentItem();

            result.BarCode = shipmentItemDto.BarCode;
            result.Id = shipmentItemDto.Id;
            result.LineItemId = shipmentItemDto.LineItemId;
            result.Quantity = shipmentItemDto.Quantity;

            if (shipmentItemDto.LineItem != null)
            {
                result.LineItem = ToOrderLineItem(shipmentItemDto.LineItem, availCurrencies, language);
            }

            return result;
        }

        public static Shipment ToOrderShipment(this orderDto.Shipment shipmentDto, IEnumerable&lt;Currency&gt; availCurrencies, Language language)
        {
            var currency = availCurrencies.FirstOrDefault(x =&gt; x.Equals(shipmentDto.Currency)) ?? new Currency(language, shipmentDto.Currency);
            var result = new Shipment(currency)
            {
                CancelledDate = shipmentDto.CancelledDate,
                CancelReason = shipmentDto.CancelReason,
                Comment = shipmentDto.Comment,
                EmployeeId = shipmentDto.EmployeeId,
                EmployeeName = shipmentDto.EmployeeName,
                FulfillmentCenterId = shipmentDto.FulfillmentCenterId,
                FulfillmentCenterName = shipmentDto.FulfillmentCenterName,
                Height = shipmentDto.Height,
                Id = shipmentDto.Id,
                Length = shipmentDto.Length,
                MeasureUnit = shipmentDto.MeasureUnit,
                Number = shipmentDto.Number,
                OperationType = shipmentDto.OperationType,
                OrganizationId = shipmentDto.OrganizationId,
                OrganizationName = shipmentDto.OrganizationName,
                ShipmentMethodCode = shipmentDto.ShipmentMethodCode,
                ShipmentMethodOption = shipmentDto.ShipmentMethodOption,
                Status = shipmentDto.Status,
                TaxType = shipmentDto.TaxType,
                Weight = shipmentDto.Weight,
                WeightUnit = shipmentDto.WeightUnit,
                Width = shipmentDto.Width,
                Currency = currency,
                CreatedBy = shipmentDto.CreatedBy,
                CreatedDate = shipmentDto.CreatedDate,
                ModifiedDate = shipmentDto.ModifiedDate,
                ModifiedBy = shipmentDto.ModifiedBy,
            };

            if (shipmentDto.DeliveryAddress != null)
            {
                result.DeliveryAddress = ToAddress(shipmentDto.DeliveryAddress);
            }

            if (!shipmentDto.Discounts.IsNullOrEmpty())
            {
                result.Discounts.AddRange(shipmentDto.Discounts.Select(x =&gt; ToDiscount(x, new[] { currency }, language)));
            }

            if (shipmentDto.DynamicProperties != null)
            {
                result.DynamicProperties = shipmentDto.DynamicProperties.Select(ToDynamicProperty).ToList();
            }

            if (shipmentDto.InPayments != null)
            {
                result.InPayments = shipmentDto.InPayments.Select(p =&gt; ToOrderInPayment(p, availCurrencies, language)).ToList();
            }

            if (shipmentDto.Items != null)
            {
                result.Items = shipmentDto.Items.Select(i =&gt; ToShipmentItem(i, availCurrencies, language)).ToList();
            }

            if (shipmentDto.Packages != null)
            {
                result.Packages = shipmentDto.Packages.Select(p =&gt; ToShipmentPackage(p, availCurrencies, language)).ToList();
            }

            result.Price = new Money(shipmentDto.Price ?? 0, currency);
            result.PriceWithTax = new Money(shipmentDto.PriceWithTax ?? 0, currency);
            result.DiscountAmount = new Money(shipmentDto.DiscountAmount ?? 0, currency);
            result.DiscountAmountWithTax = new Money(shipmentDto.DiscountAmountWithTax ?? 0, currency);
            result.Total = new Money(shipmentDto.Total ?? 0, currency);
            result.TotalWithTax = new Money(shipmentDto.TotalWithTax ?? 0, currency);
            result.TaxTotal = new Money(shipmentDto.TaxTotal ?? 0, currency);
            result.TaxPercentRate = (decimal?)shipmentDto.TaxPercentRate ?? 0m;
            if (shipmentDto.TaxDetails != null)
            {
                result.TaxDetails = shipmentDto.TaxDetails.Select(td =&gt; ToTaxDetail(td, currency)).ToList();
            }
            return result;
        }

        public static LineItem ToOrderLineItem(this orderDto.LineItem lineItemDto, IEnumerable&lt;Currency&gt; availCurrencies, Language language)
        {
            var currency = availCurrencies.FirstOrDefault(x =&gt; x.Equals(lineItemDto.Currency)) ?? new Currency(language, lineItemDto.Currency);

            var result = new LineItem(currency)
            {
                CancelledDate = lineItemDto.CancelledDate,
                CancelReason = lineItemDto.CancelReason,
                CatalogId = lineItemDto.CatalogId,
                CategoryId = lineItemDto.CategoryId,
                Height = lineItemDto.Height,
                Id = lineItemDto.Id,
                ImageUrl = lineItemDto.ImageUrl,
                IsCancelled = lineItemDto.IsCancelled,
                IsGift = lineItemDto.IsGift,
                Length = lineItemDto.Length,
                MeasureUnit = lineItemDto.MeasureUnit,
                Name = lineItemDto.Name,
                ProductId = lineItemDto.ProductId,
                Quantity = lineItemDto.Quantity,
                ReserveQuantity = lineItemDto.ReserveQuantity,
                ShippingMethodCode = lineItemDto.ShippingMethodCode,
                Sku = lineItemDto.Sku,
                TaxType = lineItemDto.TaxType,
                Weight = lineItemDto.Weight,
                WeightUnit = lineItemDto.WeightUnit,
                Width = lineItemDto.Width,
                CreatedBy = lineItemDto.CreatedBy,
                CreatedDate = lineItemDto.CreatedDate,
                ModifiedDate = lineItemDto.ModifiedDate,
                ModifiedBy = lineItemDto.ModifiedBy,
                Comment = lineItemDto.Comment,
                ProductType = lineItemDto.ProductType
            };


            result.ImageUrl = result.ImageUrl.RemoveLeadingUriScheme();
            result.Currency = currency;
            result.DiscountAmount = new Money(lineItemDto.DiscountAmount ?? 0, currency);

            if (lineItemDto.DynamicProperties != null)
            {
                result.DynamicProperties = lineItemDto.DynamicProperties.Select(ToDynamicProperty).ToList();
            }
            result.ListPrice = new Money(lineItemDto.Price ?? 0, currency);
            result.ListPriceWithTax = new Money(lineItemDto.PriceWithTax ?? 0, currency);
            result.DiscountAmount = new Money(lineItemDto.DiscountAmount ?? 0, currency);
            result.DiscountAmountWithTax = new Money(lineItemDto.DiscountAmountWithTax ?? 0, currency);
            result.PlacedPrice = new Money(lineItemDto.PlacedPrice ?? 0, currency);
            result.PlacedPriceWithTax = new Money(lineItemDto.PlacedPriceWithTax ?? 0, currency);
            result.ExtendedPrice = new Money(lineItemDto.ExtendedPrice ?? 0, currency);
            result.ExtendedPriceWithTax = new Money(lineItemDto.ExtendedPriceWithTax ?? 0, currency);
            result.DiscountTotal = new Money(lineItemDto.DiscountTotal ?? 0, currency);
            result.DiscountTotalWithTax = new Money(lineItemDto.DiscountTotalWithTax ?? 0, currency);
            result.TaxTotal = new Money(lineItemDto.TaxTotal ?? 0, currency);
            result.TaxPercentRate = (decimal?)lineItemDto.TaxPercentRate ?? 0m;
            if (!lineItemDto.Discounts.IsNullOrEmpty())
            {
                result.Discounts.AddRange(lineItemDto.Discounts.Select(x =&gt; ToDiscount(x, new[] { currency }, language)));
            }
            if (lineItemDto.TaxDetails != null)
            {
                result.TaxDetails = lineItemDto.TaxDetails.Select(td =&gt; ToTaxDetail(td, currency)).ToList();
            }

            return result;
        }

        public static LineItem ToOrderLineItem(this Model.Catalog.Product product, Currency currency, int quantity)
        {
            var result = new LineItem(currency)
            {
                CatalogId = product.CatalogId,
                CategoryId = product.CategoryId,
                Currency = currency,
                ExtendedPrice = (product.Price.SalePrice ?? product.Price.ListPrice) * quantity,
                Height = (double?)product.Height,
                ImageUrl = product.PrimaryImage?.Url,
                Length = (double?)product.Length,
                ListPrice = product.Price.ListPrice,
                MeasureUnit = product.MeasureUnit,
                Name = product.Name,
                PlacedPrice = product.Price.SalePrice ?? product.Price.ListPrice,
                ProductId = product.Id,
                ProductIsInStock = product.Inventory?.InStockQuantity &gt; 0,
                ProductType = product.ProductType,
                Quantity = quantity,
                Sku = product.Sku,
                Weight = (double?)product.Weight,
                WeightUnit = product.WeightUnit,
                Width = (double?)product.Width
            };

            CopyShortTextValue(product, result, &quot;Brand group&quot;);
            CopyShortTextValue(product, result, &quot;Unit&quot;);
            CopyShortTextValue(product, result, &quot;Packaging&quot;);
            CopyDecimalValue(product, result, &quot;Product volume&quot;);
            CopyDecimalValue(product, result, &quot;Empties Deposit&quot;);

            return result;
        }

        public static PaymentIn ToOrderInPayment(this orderDto.PaymentIn paymentIn, IEnumerable&lt;Currency&gt; availCurrencies, Language language)
        {
            var currency = availCurrencies.FirstOrDefault(x =&gt; x.Equals(paymentIn.Currency)) ?? new Currency(language, paymentIn.Currency);
            var retVal = new PaymentIn(currency)
            {
                CancelledDate = paymentIn.CancelledDate,
                CancelReason = paymentIn.CancelReason,
                Comment = paymentIn.Comment,
                CustomerId = paymentIn.CustomerId,
                CustomerName = paymentIn.CustomerName,
                GatewayCode = paymentIn.GatewayCode,
                Id = paymentIn.Id,
                IncomingDate = paymentIn.IncomingDate,
                IsApproved = paymentIn.IsApproved,
                IsCancelled = paymentIn.IsCancelled,
                CreatedBy = paymentIn.CreatedBy,
                CreatedDate = paymentIn.CreatedDate,
                ModifiedDate = paymentIn.ModifiedDate,
                ModifiedBy = paymentIn.ModifiedBy,
                Number = paymentIn.Number
            };
            retVal.IsCancelled = paymentIn.IsCancelled;
            retVal.Number = paymentIn.Number;
            retVal.OperationType = paymentIn.OperationType;
            retVal.OrganizationId = paymentIn.OrganizationId;
            retVal.OrganizationName = paymentIn.OrganizationName;
            retVal.OuterId = paymentIn.OuterId;
            retVal.ParentOperationId = paymentIn.ParentOperationId;
            retVal.Purpose = paymentIn.Purpose;
            retVal.Status = paymentIn.Status;


            if (paymentIn.BillingAddress != null)
            {
                retVal.BillingAddress = paymentIn.BillingAddress.ToAddress();
            }

            if (paymentIn.DynamicProperties != null)
            {
                retVal.DynamicProperties = paymentIn.DynamicProperties.Select(ToDynamicProperty).ToList();
            }

            retVal.Sum = new Money(paymentIn.Sum ?? 0, currency);

            if (paymentIn.PaymentMethod != null)
            {
                retVal.GatewayCode = paymentIn.PaymentMethod.Code;
                retVal.PaymentMethodType = paymentIn.PaymentMethod.PaymentMethodType;
            }

            retVal.Price = new Money(paymentIn.Price ?? 0, currency);
            retVal.DiscountAmount = new Money(paymentIn.DiscountAmount ?? 0, currency);
            retVal.TaxPercentRate = (decimal?)paymentIn.TaxPercentRate ?? 0m;

            return retVal;
        }

        public static orderDto.PaymentIn ToOrderPaymentInDto(this PaymentIn payment)
        {
            var retVal = new orderDto.PaymentIn
            {
                CancelledDate = payment.CancelledDate,
                CancelReason = payment.CancelReason,
                Comment = payment.Comment,
                CustomerId = payment.CustomerId,
                CustomerName = payment.CustomerName,
                GatewayCode = payment.GatewayCode,
                Id = payment.Id,
                IncomingDate = payment.IncomingDate,
                IsApproved = payment.IsApproved,
                IsCancelled = payment.IsCancelled,
                CreatedBy = payment.CreatedBy,
                CreatedDate = payment.CreatedDate,
                ModifiedDate = payment.ModifiedDate,
                ModifiedBy = payment.ModifiedBy,
                Number = payment.Number
            };
            retVal.IsCancelled = payment.IsCancelled;
            retVal.Number = payment.Number;
            retVal.OperationType = payment.OperationType;
            retVal.OrganizationId = payment.OrganizationId;
            retVal.OrganizationName = payment.OrganizationName;
            retVal.OuterId = payment.OuterId;
            retVal.ParentOperationId = payment.ParentOperationId;
            retVal.Purpose = payment.Purpose;
            retVal.Status = payment.Status;

            retVal.Sum = (double)payment.Sum.Amount;
            retVal.Currency = payment.Currency.Code;
            retVal.PaymentStatus = payment.Status;

            if (payment.BillingAddress != null)
            {
                retVal.BillingAddress = payment.BillingAddress.ToOrderAddressDto();
            }

            if (payment.DynamicProperties != null)
            {
                retVal.DynamicProperties = payment.DynamicProperties.Select(ToOrderDynamicPropertyDto).ToList();
            }

            //if (payment.GatewayCode != null)
            //{
            //    var a = retVal.GatewayCode;
            //}

            retVal.TaxPercentRate = (double)payment.TaxPercentRate;
            retVal.DiscountAmount = (double)payment.DiscountAmount.InternalAmount;
            retVal.Price = (double)payment.Price.InternalAmount;

            return retVal;
        }
        public static orderDto.BankCardInfo ToBankCardInfoDto(this BankCardInfo model)
        {
            orderDto.BankCardInfo retVal = null;
            if (model != null)
            {
                retVal = new orderDto.BankCardInfo
                {
                    BankCardCVV2 = model.BankCardCVV2,
                    BankCardMonth = model.BankCardMonth,
                    BankCardNumber = model.BankCardNumber,
                    BankCardType = model.BankCardType,
                    BankCardYear = model.BankCardYear,
                    CardholderName = model.CardholderName
                };
            }

            return retVal;
        }

        public static Discount ToDiscount(this orderDto.Discount discountDto, IEnumerable&lt;Currency&gt; availCurrencies, Language language)
        {
            var currency = availCurrencies.FirstOrDefault(x =&gt; x.Equals(discountDto.Currency)) ?? new Currency(language, discountDto.Currency);
            var result = new Discount(currency)
            {
                Coupon = discountDto.Coupon,
                Description = discountDto.Description,
                PromotionId = discountDto.PromotionId,

                Amount = new Money(discountDto.DiscountAmount ?? 0, currency)
            };

            return result;
        }

        public static CustomerOrder ToCustomerOrder(this orderDto.CustomerOrder order, IEnumerable&lt;Currency&gt; availCurrencies, Language language)
        {
            var currency = availCurrencies.FirstOrDefault(x =&gt; x.Equals(order.Currency)) ?? new Currency(language, order.Currency);

            var result = new CustomerOrder(currency)
            {
                CancelledDate = order.CancelledDate,
                CancelReason = order.CancelReason,
                ChannelId = order.ChannelId,
                Comment = order.Comment,
                CreatedBy = order.CreatedBy,
                CreatedDate = order.CreatedDate,
                ModifiedDate = order.ModifiedDate,
                CustomerId = order.CustomerId,
                CustomerName = order.CustomerName,
                EmployeeId = order.EmployeeId,
                EmployeeName = order.EmployeeName,
                Id = order.Id,
                IsApproved = order.IsApproved,
                IsCancelled = order.IsCancelled,
                ModifiedBy = order.ModifiedBy,
                Number = order.Number,
                OrganizationId = order.OrganizationId,
                OrganizationName = order.OrganizationName,
                Status = order.Status,
                StoreId = order.StoreId,
                StoreName = order.StoreName,
                SubscriptionNumber = order.SubscriptionNumber,
                OperationType = order.OperationType,
                OutletDisId = order.OutletDisId,
                OutletId = order.OutletId,
                OutletName = order.OutletName
            };

            result.Language = string.IsNullOrEmpty(order.LanguageCode) ? Language.InvariantLanguage : new Language(order.LanguageCode);

            if (order.Addresses != null)
            {
                result.Addresses = order.Addresses.Select(ToAddress).ToList();
            }


            if (order.DynamicProperties != null)
            {
                // HAP: Exclude secret properties
                result.DynamicProperties = order.DynamicProperties
                    .Where(p =&gt; !p.Name.EqualsInvariant(DistributorAccessKey.PropertyName))
                    .Select(ToDynamicProperty)
                    .ToList();
            }

            if (order.InPayments != null)
            {
                result.InPayments = order.InPayments.Select(p =&gt; ToOrderInPayment(p, availCurrencies, language)).ToList();
            }

            if (order.Items != null)
            {
                result.Items = order.Items.Select(i =&gt; ToOrderLineItem(i, availCurrencies, language)).ToList();
            }

            if (order.Shipments != null)
            {
                result.Shipments = order.Shipments.Select(s =&gt; ToOrderShipment(s, availCurrencies, language)).ToList();
            }

            if (!order.Discounts.IsNullOrEmpty())
            {
                result.Discounts.AddRange(order.Discounts.Select(x =&gt; ToDiscount(x, new[] { currency }, language)));
            }
            if (order.TaxDetails != null)
            {
                result.TaxDetails = order.TaxDetails.Select(td =&gt; ToTaxDetail(td, currency)).ToList();
            }
            result.DiscountAmount = new Money(order.DiscountAmount ?? 0, currency);
            result.DiscountTotal = new Money(order.DiscountTotal ?? 0, currency);
            result.DiscountTotalWithTax = new Money(order.DiscountTotalWithTax ?? 0, currency);

            result.PaymentTotal = new Money(order.PaymentTotal ?? 0, currency);
            result.PaymentTotalWithTax = new Money(order.PaymentTotalWithTax ?? 0, currency);
            result.PaymentDiscountTotal = new Money(order.PaymentDiscountTotal ?? 0, currency);
            result.PaymentDiscountTotalWithTax = new Money(order.PaymentDiscountTotalWithTax ?? 0, currency);
            result.PaymentTaxTotal = new Money(order.PaymentTaxTotal ?? 0, currency);
            result.PaymentPrice = new Money(order.PaymentSubTotal ?? 0, currency);
            result.PaymentPriceWithTax = new Money(order.PaymentSubTotalWithTax ?? 0, currency);

            result.Total = new Money(order.Total ?? 0, currency);
            result.SubTotal = new Money(order.SubTotal ?? 0, currency);
            result.SubTotalWithTax = new Money(order.SubTotalWithTax ?? 0, currency);
            result.TaxTotal = new Money(order.TaxTotal ?? 0, currency);

            result.ShippingTotal = new Money(order.ShippingTotal ?? 0, currency);
            result.ShippingTotalWithTax = new Money(order.ShippingTotalWithTax ?? 0, currency);
            result.ShippingTaxTotal = new Money(order.ShippingTaxTotal ?? 0, currency);
            result.ShippingPrice = new Money(order.ShippingSubTotal ?? 0, currency);
            result.ShippingPriceWithTax = new Money(order.ShippingSubTotalWithTax ?? 0, currency);

            result.SubTotalTaxTotal = new Money(order.SubTotalTaxTotal ?? 0, currency);
            result.SubTotalDiscount = new Money(order.SubTotalDiscount ?? 0, currency);
            result.SubTotalDiscountWithTax = new Money(order.SubTotalDiscountWithTax ?? 0, currency);


            return result;
        }

        public static TaxDetail ToTaxDetail(this orderDto.TaxDetail taxDetailDto, Currency currency)
        {
            var result = new TaxDetail(currency)
            {
                Name = taxDetailDto.Name,
                Amount = new Money(taxDetailDto.Amount ?? 0, currency),
                Rate = new Money(taxDetailDto.Rate ?? 0, currency)
            };
            return result;
        }

        public static PaymentMethod ToPaymentMethod(this storeDto.PaymentMethod paymentMethodDto, CustomerOrder order)
        {
            var retVal = new PaymentMethod(order.Currency)
            {
                Code = paymentMethodDto.Code,
                Description = paymentMethodDto.Currency,
                IsAvailableForPartial = paymentMethodDto.IsAvailableForPartial ?? false,
                LogoUrl = paymentMethodDto.LogoUrl,
                Name = paymentMethodDto.Name,
                PaymentMethodGroupType = paymentMethodDto.PaymentMethodGroupType,
                PaymentMethodType = paymentMethodDto.PaymentMethodType,
                TaxType = paymentMethodDto.TaxType,

                Priority = paymentMethodDto.Priority ?? 0
            };

            if (paymentMethodDto.Settings != null)
            {
                retVal.Settings = paymentMethodDto.Settings.Where(x =&gt; !x.ValueType.EqualsInvariant(&quot;SecureString&quot;)).Select(x =&gt; x.JsonConvert&lt;platformDto.Setting&gt;().ToSettingEntry()).ToList();
            }

            retVal.Currency = order.Currency;
            retVal.Price = new Money(paymentMethodDto.Price ?? 0, order.Currency);
            retVal.DiscountAmount = new Money(paymentMethodDto.DiscountAmount ?? 0, order.Currency);
            retVal.TaxPercentRate = (decimal?)paymentMethodDto.TaxPercentRate ?? 0m;

            if (paymentMethodDto.TaxDetails != null)
            {
                retVal.TaxDetails = paymentMethodDto.TaxDetails.Select(td =&gt; ToTaxDetail(td, order.Currency)).ToList();
            }

            return retVal;
        }

        public static TaxDetail ToTaxDetail(this storeDto.TaxDetail dto, Currency currency)
        {
            var result = new TaxDetail(currency)
            {
                Amount = new Money(dto.Amount ?? 0, currency),
                Rate = new Money(dto.Rate ?? 0, currency),
                Name = dto.Name
            };
            return result;
        }

        public static orderDto.CustomerOrder ToCustomerOrderDto(this CustomerOrder order)
        {
            var result = new orderDto.CustomerOrder
            {
                CancelledDate = order.CancelledDate,
                CancelReason = order.CancelReason,
                ChannelId = order.ChannelId,
                Comment = order.Comment,
                CreatedBy = order.CreatedBy,
                CreatedDate = order.CreatedDate,
                ModifiedDate = order.ModifiedDate,
                CustomerId = order.CustomerId,
                CustomerName = order.CustomerName,
                EmployeeId = order.EmployeeId,
                EmployeeName = order.EmployeeName,
                Id = order.Id,
                IsApproved = order.IsApproved,
                IsCancelled = order.IsCancelled,
                ModifiedBy = order.ModifiedBy,
                Number = order.Number,
                OrganizationId = order.OrganizationId,
                OrganizationName = order.OrganizationName,
                Status = order.Status.EqualsInvariant(&quot;Received&quot;) ? &quot;Sent to distributor&quot; : order.Status,
                StoreId = order.StoreId,
                StoreName = order.StoreName,
                SubscriptionNumber = order.SubscriptionNumber,
                DiscountAmount = (double)order.DiscountAmount.InternalAmount,
                Currency = order.Currency.Code,
                OperationType = order.OperationType,
                OutletDisId = order.OutletDisId,
                OutletId = order.OutletId,
                OutletName = order.OutletName
            };

            if (order.Language != null)
            {
                result.LanguageCode = order.Language.CultureName;
            }

            result.Addresses = order.Addresses.Select(ToOrderAddressDto).ToList();
            result.DynamicProperties = order.DynamicProperties.Select(ToOrderDynamicPropertyDto).ToList();
            result.Items = order.Items.Select(ToOrderLineItemDto).ToList();
            result.Discounts = order.Discounts.Select(ToOrderDiscountDto).ToList();
            result.TaxDetails = order.TaxDetails.Select(ToOrderTaxDetailDto).ToList();
            result.Shipments = order.Shipments.Select(ToOrderShipmentDto).ToList();
            result.InPayments = order.InPayments.Select(ToOrderPaymentInDto).ToList();

            return result;
        }

        public static orderDto.LineItem ToOrderLineItemDto(this LineItem lineItem)
        {

            var result = new orderDto.LineItem
            {
                CancelledDate = lineItem.CancelledDate,
                CancelReason = lineItem.CancelReason,
                CatalogId = lineItem.CatalogId,
                CategoryId = lineItem.CategoryId,
                Height = lineItem.Height,
                Id = lineItem.Id,
                ImageUrl = lineItem.ImageUrl,
                IsCancelled = lineItem.IsCancelled,
                IsGift = lineItem.IsGift,
                Length = lineItem.Length,
                MeasureUnit = lineItem.MeasureUnit,
                Name = lineItem.Name,
                ProductId = lineItem.ProductId,
                Quantity = lineItem.Quantity,
                ReserveQuantity = lineItem.ReserveQuantity,
                ShippingMethodCode = lineItem.ShippingMethodCode,
                Sku = lineItem.Sku,
                TaxType = lineItem.TaxType,
                Weight = lineItem.Weight,
                WeightUnit = lineItem.WeightUnit,
                Width = lineItem.Width,
                ProductType = lineItem.ProductType,
                Comment = lineItem.Comment,
                Currency = lineItem.Currency.Code,
                TaxPercentRate = (double)lineItem.TaxPercentRate,
                DiscountAmount = (double)lineItem.DiscountAmount.InternalAmount,
                Price = (double)lineItem.ListPrice.InternalAmount
            };

            result.Discounts = lineItem.Discounts.Select(ToOrderDiscountDto).ToList();
            result.TaxDetails = lineItem.TaxDetails.Select(ToOrderTaxDetailDto).ToList();
            result.DynamicProperties = lineItem.DynamicProperties.Select(ToOrderDynamicPropertyDto).ToList();

            return result;
        }

        public static orderDto.TaxDetail ToOrderTaxDetailDto(this TaxDetail taxDetail)
        {
            var result = new orderDto.TaxDetail
            {
                Name = taxDetail.Name,
                Rate = (double)taxDetail.Rate.Amount
            };
            return result;
        }

        public static orderDto.Discount ToOrderDiscountDto(this Discount discount)
        {
            var result = new orderDto.Discount
            {
                PromotionId = discount.PromotionId,
                Coupon = discount.Coupon,
                Description = discount.Description,
                Currency = discount.Amount.Currency.Code,
                DiscountAmount = (double)discount.Amount.Amount
            };
            return result;
        }

        public static orderDto.Shipment ToOrderShipmentDto(this Shipment shipment)
        {
            var result = new orderDto.Shipment
            {
                CancelledDate = shipment.CancelledDate,
                CancelReason = shipment.CancelReason,
                Comment = shipment.Comment,
                EmployeeId = shipment.EmployeeId,
                EmployeeName = shipment.EmployeeName,
                FulfillmentCenterId = shipment.FulfillmentCenterId,
                FulfillmentCenterName = shipment.FulfillmentCenterName,
                Id = shipment.Id,
                Length = shipment.Length,
                MeasureUnit = shipment.MeasureUnit,
                Number = shipment.Number,
                OperationType = shipment.OperationType,
                OrganizationId = shipment.OrganizationId,
                OrganizationName = shipment.OrganizationName,
                ShipmentMethodCode = shipment.ShipmentMethodCode,
                ShipmentMethodOption = shipment.ShipmentMethodOption,
                Status = shipment.Status,
                TaxType = shipment.TaxType,
                Weight = shipment.Weight,
                WeightUnit = shipment.WeightUnit,
                Width = shipment.Width,
                Height = shipment.Height,
                Currency = shipment.Currency != null ? shipment.Currency.Code : null,
                DiscountAmount = shipment.DiscountAmount != null ? (double?)shipment.DiscountAmount.InternalAmount : null,
                Price = shipment.Price != null ? (double?)shipment.Price.InternalAmount : null,
                TaxPercentRate = (double)shipment.TaxPercentRate
            };

            if (shipment.DeliveryAddress != null)
            {
                result.DeliveryAddress = ToOrderAddressDto(shipment.DeliveryAddress);
            }

            result.Discounts = shipment.Discounts.Select(ToOrderDiscountDto).ToList();
            result.Items = shipment.Items.Select(ToShipmentItemDto).ToList();
            result.TaxDetails = shipment.TaxDetails.Select(ToOrderTaxDetailDto).ToList();
            result.DynamicProperties = shipment.DynamicProperties.Select(ToOrderDynamicPropertyDto).ToList();

            return result;
        }

        public static orderDto.ShipmentItem ToShipmentItemDto(this ShipmentItem shipmentItem)
        {
            var result = new orderDto.ShipmentItem
            {
                Id = shipmentItem.Id,
                LineItemId = shipmentItem.LineItemId,
                BarCode = shipmentItem.BarCode,
                Quantity = shipmentItem.Quantity,
                LineItem = shipmentItem.LineItem?.ToOrderLineItemDto()
            };

            return result;
        }

        private static void CopyShortTextValue(Product source, LineItem target, string propertyName)
        {
            var value = source.Properties.GetValue(propertyName);
            target.DynamicProperties.SetShortTextValue(propertyName, value);
        }

        private static void CopyDecimalValue(Product source, LineItem target, string propertyName)
        {
            var stringValue = source.Properties.GetValue(propertyName)?.Replace(&#39;,&#39;, &#39;.&#39;); // Workaround for current catalog data
            if (decimal.TryParse(stringValue, NumberStyles.Float, CultureInfo.InvariantCulture, out var decimalValue))
            {
                target.DynamicProperties.SetDecimalValue(propertyName, decimalValue);
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,9,22,10,0],[23,13,36,15,0],[38,13,38,27,0],[39,9,39,10,0],[42,9,42,10,0],[43,13,43,97,0],[44,9,44,10,0],[47,9,47,10,0],[48,13,48,98,0],[49,9,49,10,0],[52,9,52,10,0],[53,13,53,79,0],[54,9,54,10,0],[57,9,57,10,0],[58,13,58,74,0],[59,9,59,10,0],[62,9,62,10,0],[63,13,74,15,0],[76,13,76,50,0],[77,13,77,14,0],[78,17,78,119,0],[78,69,78,108,0],[79,13,79,14,0],[81,13,81,27,0],[82,9,82,10,0],[85,9,85,10,0],[86,13,86,45,0],[88,13,88,54,0],[89,13,89,44,0],[90,13,90,60,0],[91,13,91,56,0],[93,13,93,50,0],[94,13,94,14,0],[95,17,95,104,0],[96,13,96,14,0],[98,13,98,27,0],[99,9,99,10,0],[102,9,102,10,0],[103,13,103,144,0],[103,64,103,94,0],[104,13,133,15,0],[135,13,135,53,0],[136,13,136,14,0],[137,17,137,81,0],[138,13,138,14,0],[140,13,140,56,0],[141,13,141,14,0],[142,17,142,123,0],[142,77,142,120,0],[143,13,143,14,0],[145,13,145,55,0],[146,13,146,14,0],[147,17,147,109,0],[148,13,148,14,0],[150,13,150,48,0],[151,13,151,14,0],[152,17,152,129,0],[152,72,152,118,0],[153,13,153,14,0],[155,13,155,43,0],[156,13,156,14,0],[157,17,157,117,0],[157,62,157,106,0],[158,13,158,14,0],[160,13,160,46,0],[161,13,161,14,0],[162,17,162,126,0],[162,68,162,115,0],[163,13,163,14,0],[165,13,165,72,0],[166,13,166,86,0],[167,13,167,90,0],[168,13,168,104,0],[169,13,169,72,0],[170,13,170,86,0],[171,13,171,78,0],[172,13,172,80,0],[173,13,173,48,0],[174,13,174,14,0],[175,17,175,109,0],[175,73,175,98,0],[176,13,176,14,0],[177,13,177,27,0],[178,9,178,10,0],[181,9,181,10,0],[182,13,182,144,0],[182,64,182,94,0],[184,13,213,15,0],[216,13,216,72,0],[217,13,217,40,0],[218,13,218,90,0],[220,13,220,55,0],[221,13,221,14,0],[222,17,222,109,0],[223,13,223,14,0],[224,13,224,76,0],[225,13,225,90,0],[226,13,226,90,0],[227,13,227,104,0],[228,13,228,84,0],[229,13,229,98,0],[230,13,230,88,0],[231,13,231,102,0],[232,13,232,88,0],[233,13,233,102,0],[234,13,234,78,0],[235,13,235,80,0],[236,13,236,56,0],[237,13,237,14,0],[238,17,238,123,0],[238,77,238,120,0],[239,13,239,14,0],[240,13,240,48,0],[241,13,241,14,0],[242,17,242,109,0],[242,73,242,98,0],[243,13,243,14,0],[245,13,245,27,0],[246,9,246,10,0],[249,9,249,10,0],[250,13,271,15,0],[273,13,273,64,0],[274,13,274,57,0],[275,13,275,62,0],[276,13,276,65,0],[277,13,277,66,0],[279,13,279,27,0],[280,9,280,10,0],[283,9,283,10,0],[284,13,284,140,0],[284,64,284,92,0],[285,13,302,15,0],[303,13,303,56,0],[304,13,304,46,0],[305,13,305,60,0],[306,13,306,62,0],[307,13,307,66,0],[308,13,308,48,0],[309,13,309,68,0],[310,13,310,48,0],[311,13,311,46,0],[314,13,314,50,0],[315,13,315,14,0],[316,17,316,78,0],[317,13,317,14,0],[319,13,319,53,0],[320,13,320,14,0],[321,17,321,107,0],[322,13,322,14,0],[324,13,324,66,0],[326,13,326,49,0],[327,13,327,14,0],[328,17,328,67,0],[329,17,329,86,0],[330,13,330,14,0],[332,13,332,70,0],[333,13,333,88,0],[334,13,334,78,0],[336,13,336,27,0],[337,9,337,10,0],[340,9,340,10,0],[341,13,358,15,0],[359,13,359,54,0],[360,13,360,44,0],[361,13,361,58,0],[362,13,362,60,0],[363,13,363,64,0],[364,13,364,46,0],[365,13,365,66,0],[366,13,366,46,0],[367,13,367,44,0],[369,13,369,53,0],[370,13,370,53,0],[371,13,371,51,0],[373,13,373,48,0],[374,13,374,14,0],[375,17,375,84,0],[376,13,376,14,0],[378,13,378,51,0],[379,13,379,14,0],[380,17,380,113,0],[381,13,381,14,0],[388,13,388,68,0],[389,13,389,83,0],[390,13,390,65,0],[392,13,392,27,0],[393,9,393,10,0],[395,9,395,10,0],[396,13,396,49,0],[397,13,397,31,0],[398,13,398,14,0],[399,17,407,19,0],[408,13,408,14,0],[410,13,410,27,0],[411,9,411,10,0],[414,9,414,10,0],[415,13,415,144,0],[415,64,415,94,0],[416,13,423,15,0],[425,13,425,27,0],[426,9,426,10,0],[429,9,429,10,0],[430,13,430,132,0],[430,64,430,88,0],[432,13,460,15,0],[462,13,462,136,0],[464,13,464,41,0],[465,13,465,14,0],[466,17,466,79,0],[467,13,467,14,0],[470,13,470,49,0],[471,13,471,14,0],[473,17,476,31,0],[474,33,474,91,0],[477,13,477,14,0],[479,13,479,42,0],[480,13,480,14,0],[481,17,481,123,0],[481,66,481,112,0],[482,13,482,14,0],[484,13,484,37,0],[485,13,485,14,0],[486,17,486,112,0],[486,56,486,101,0],[487,13,487,14,0],[489,13,489,41,0],[490,13,490,14,0],[491,17,491,120,0],[491,64,491,109,0],[492,13,492,14,0],[494,13,494,50,0],[495,13,495,14,0],[496,17,496,117,0],[496,71,496,114,0],[497,13,497,14,0],[498,13,498,42,0],[499,13,499,14,0],[500,17,500,103,0],[500,67,500,92,0],[501,13,501,14,0],[502,13,502,84,0],[503,13,503,82,0],[504,13,504,96,0],[506,13,506,80,0],[507,13,507,94,0],[508,13,508,96,0],[509,13,509,110,0],[510,13,510,86,0],[511,13,511,83,0],[512,13,512,97,0],[514,13,514,66,0],[515,13,515,72,0],[516,13,516,86,0],[517,13,517,72,0],[519,13,519,82,0],[520,13,520,96,0],[521,13,521,88,0],[522,13,522,85,0],[523,13,523,99,0],[525,13,525,88,0],[526,13,526,88,0],[527,13,527,102,0],[530,13,530,27,0],[531,9,531,10,0],[534,9,534,10,0],[535,13,540,15,0],[541,13,541,27,0],[542,9,542,10,0],[545,9,545,10,0],[546,13,558,15,0],[560,13,560,51,0],[561,13,561,14,0],[562,17,562,194,0],[562,72,562,116,0],[562,130,562,183,0],[563,13,563,14,0],[565,13,565,46,0],[566,13,566,83,0],[567,13,567,101,0],[568,13,568,85,0],[570,13,570,53,0],[571,13,571,14,0],[572,17,572,120,0],[572,78,572,109,0],[573,13,573,14,0],[575,13,575,27,0],[576,9,576,10,0],[579,9,579,10,0],[580,13,585,15,0],[586,13,586,27,0],[587,9,587,10,0],[590,9,590,10,0],[591,13,621,15,0],[623,13,623,40,0],[624,13,624,14,0],[625,17,625,66,0],[626,13,626,14,0],[628,13,628,83,0],[629,13,629,107,0],[630,13,630,76,0],[631,13,631,84,0],[632,13,632,87,0],[633,13,633,84,0],[634,13,634,87,0],[636,13,636,27,0],[637,9,637,10,0],[640,9,640,10,0],[642,13,671,15,0],[673,13,673,87,0],[674,13,674,90,0],[675,13,675,110,0],[677,13,677,27,0],[678,9,678,10,0],[681,9,681,10,0],[682,13,686,15,0],[687,13,687,27,0],[688,9,688,10,0],[691,9,691,10,0],[692,13,699,15,0],[700,13,700,27,0],[701,9,701,10,0],[704,9,704,10,0],[705,13,733,15,0],[735,13,735,50,0],[736,13,736,14,0],[737,17,737,86,0],[738,13,738,14,0],[740,13,740,87,0],[741,13,741,78,0],[742,13,742,90,0],[743,13,743,110,0],[745,13,745,27,0],[746,9,746,10,0],[749,9,749,10,0],[750,13,757,15,0],[759,13,759,27,0],[760,9,760,10,0],[763,9,763,10,0],[764,13,764,66,0],[765,13,765,77,0],[766,9,766,10,0],[769,9,769,10,0],[770,13,770,91,0],[771,13,771,119,0],[772,13,772,14,0],[773,17,773,86,0],[774,13,774,14,0],[775,9,775,10,0]]);
    </script>
  </body>
</html>