<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\data\sources\heineken-asia-pacific\hru-storefront-core\virtocommerce.storefront.model\catalog\product.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using VirtoCommerce.Storefront.Model.Common;
using VirtoCommerce.Storefront.Model.Marketing;
using VirtoCommerce.Storefront.Model.Subscriptions;

namespace VirtoCommerce.Storefront.Model.Catalog
{
    public partial class Product : Entity, IDiscountable, ITaxable
    {
        public Product()
        {
            Properties = new List&lt;CatalogProperty&gt;();
            VariationProperties = new List&lt;CatalogProperty&gt;();
            Prices = new List&lt;ProductPrice&gt;();
            Assets = new List&lt;Asset&gt;();
            Variations = new List&lt;Product&gt;();
            Images = new List&lt;Image&gt;();
            Descriptions = new List&lt;EditorialReview&gt;();
            Discounts = new List&lt;Discount&gt;();
            Associations = new List&lt;Association&gt;();
            TaxDetails = new List&lt;TaxDetail&gt;();
        }

        public Product(Currency currency, Language language)
            : this()
        {
            Currency = currency;
            Price = new ProductPrice(currency);
        }

        /// &lt;summary&gt;
        /// Manufacturer part number for this product
        /// &lt;/summary&gt;
        public string ManufacturerPartNumber { get; set; }

        /// &lt;summary&gt;
        /// Global trade item number
        /// &lt;/summary&gt;
        public string Gtin { get; set; }

        /// &lt;summary&gt;
        /// Product code
        /// &lt;/summary&gt;
        public string Sku { get; set; }

        /// &lt;summary&gt;
        /// Name of this product
        /// &lt;/summary&gt;
        public string Name { get; set; }

        /// &lt;summary&gt;
        /// Product catalog id
        /// &lt;/summary&gt;
        public string CatalogId { get; set; }

        /// &lt;summary&gt;
        /// Category id of this product
        /// &lt;/summary&gt;
        public string CategoryId { get; set; }

        /// &lt;summary&gt;
        /// All parent categories ids concatenated with &quot;/&quot;. E.g. (1/21/344)
        /// &lt;/summary&gt;
        public string Outline { get; set; }
        /// &lt;summary&gt;
        /// Slug path e.g /camcorders/blue-win-camera
        /// &lt;/summary&gt;
        public string SeoPath { get; set; }
        /// &lt;summary&gt;
        /// Application relative url e.g ~/camcorders/blue-win-camera
        /// &lt;/summary&gt;
        public string Url { get; set; }
        /// &lt;summary&gt;
        /// Date of last indexing of product, if null - product never was indexed
        /// &lt;/summary&gt;
        public DateTime? IndexingDate { get; set; }

        /// &lt;summary&gt;
        /// Titular item id for a variation
        /// &lt;/summary&gt;
        public string TitularItemId { get; set; }

        /// &lt;summary&gt;
        /// Indicating whether this product is buyable
        /// &lt;/summary&gt;
        public bool IsBuyable { get; set; }

        /// &lt;summary&gt;
        /// Indicating whether this product is instock
        /// &lt;/summary&gt;
        public bool IsInStock { get; set; }

        /// &lt;summary&gt;
        /// Indicating whether this product is active
        /// &lt;/summary&gt;
        public bool IsActive { get; set; }

        /// &lt;summary&gt;
        /// Indicating whether this product inventory is tracked
        /// &lt;/summary&gt;
        public bool TrackInventory { get; set; }

        /// &lt;summary&gt;
        /// Maximum quantity of the product that a customer can buy
        /// &lt;/summary&gt;
        public int MaxQuantity { get; set; }

        /// &lt;summary&gt;
        /// Minimum quantity of the product that a customer can buy
        /// &lt;/summary&gt;
        public int MinQuantity { get; set; }

        /// &lt;summary&gt;
        /// Type of product (can be Physical, Digital or Subscription)
        /// &lt;/summary&gt;
        public string ProductType { get; set; }

        /// &lt;summary&gt;
        /// Weight unit (for physical product only)
        /// &lt;/summary&gt;
        public string WeightUnit { get; set; }

        /// &lt;summary&gt;
        /// Weight of product (for physical product only)
        /// &lt;/summary&gt;
        public decimal? Weight { get; set; }

        /// &lt;summary&gt;
        /// Package type
        /// &lt;/summary&gt;
        public string PackageType { get; set; }

        /// &lt;summary&gt;
        /// Package size
        /// &lt;/summary&gt;
        public int PackageSize { get; set; }

        /// &lt;summary&gt;
        /// Minimum order quantity
        /// &lt;/summary&gt;
        public int MinOrderQuantity { get; set; }

        /// &lt;summary&gt;
        /// Dimensions measure unit of size (for physical product only)
        /// &lt;/summary&gt;
        public string MeasureUnit { get; set; }

        /// &lt;summary&gt;
        /// Height of product size (for physical product only)
        /// &lt;/summary&gt;
        public decimal? Height { get; set; }

        /// &lt;summary&gt;
        /// Length of product size (for physical product only)
        /// &lt;/summary&gt;
        public decimal? Length { get; set; }

        /// &lt;summary&gt;
        /// Width of product size (for physical product only)
        /// &lt;/summary&gt;
        public decimal? Width { get; set; }

        /// &lt;summary&gt;
        /// Indicating whether this product can be reviewed in storefront
        /// &lt;/summary&gt;
        public bool EnableReview { get; set; }

        /// &lt;summary&gt;
        /// Maximum number of downloads of product (for digital product only)
        /// &lt;/summary&gt;
        public decimal MaxNumberOfDownload { get; set; }

        /// &lt;summary&gt;
        /// Download expiration date (for digital product only)
        /// &lt;/summary&gt;
        public DateTime? DownloadExpiration { get; set; }

        /// &lt;summary&gt;
        /// Type of the download (for digital product only)
        /// &lt;/summary&gt;
        public string DownloadType { get; set; }

        /// &lt;summary&gt;
        /// Indicating whether this product has user agreement (for digital product only)
        /// &lt;/summary&gt;
        public bool HasUserAgreement { get; set; }

        /// &lt;summary&gt;
        /// Type of product shipping
        /// &lt;/summary&gt;
        public string ShippingType { get; set; }

        public string VendorId { get; set; }

        /// &lt;summary&gt;
        /// Product&#39;s vendor
        /// &lt;/summary&gt;
        public Vendor Vendor { get; set; }

        /// &lt;summary&gt;
        /// List og variation properties
        /// &lt;/summary&gt;
        public IList&lt;CatalogProperty&gt; VariationProperties { get; set; }

        /// &lt;summary&gt;
        /// List of product assets
        /// &lt;/summary&gt;
        public IList&lt;Asset&gt; Assets { get; set; }

        /// &lt;summary&gt;
        /// List of product variations
        /// &lt;/summary&gt;
        public IList&lt;Product&gt; Variations { get; set; }

        /// &lt;summary&gt;
        /// Related or associated products
        /// &lt;/summary&gt;
        public IList&lt;Association&gt; Associations { get; set; }

        /// &lt;summary&gt;
        /// Product description in current language
        /// &lt;/summary&gt;
        public string Description { get; set; }

        /// &lt;summary&gt;
        /// Product editorial reviews
        /// &lt;/summary&gt;
        public IList&lt;EditorialReview&gt; Descriptions { get; set; }

        /// &lt;summary&gt;
        /// Current product price
        /// &lt;/summary&gt;
        public ProductPrice Price { get; set; }

        /// &lt;summary&gt;
        /// Product prices for other currencies
        /// &lt;/summary&gt;
        public IList&lt;ProductPrice&gt; Prices { get; set; }

        /// &lt;summary&gt;
        /// Inventory for default fulfillment center
        /// &lt;/summary&gt;
        public Inventory.ProductInventory Inventory { get; set; }

        /// &lt;summary&gt;
        /// Inventory of all fulfillment centers.
        /// &lt;/summary&gt;
        public IList&lt;Inventory.ProductInventory&gt; InventoryAll { get; set; }

        public virtual long AvailableQuantity
        {
            get
            {
                long result = 0;

                if (TrackInventory &amp;&amp; InventoryAll != null)
                {
                    foreach (var inventory in InventoryAll)
                    {
                        result += Math.Max(0, (inventory.InStockQuantity ?? 0L) - (inventory.ReservedQuantity ?? 0L));
                    }
                }
                return result;
            }
        }

        /// &lt;summary&gt;
        /// product seo info
        /// &lt;/summary&gt;
        public SeoInfo SeoInfo { get; set; }

        /// &lt;summary&gt;
        /// Product main image
        /// &lt;/summary&gt;
        public Image PrimaryImage { get; set; }

        /// &lt;summary&gt;
        /// List of product images
        /// &lt;/summary&gt;
        public IList&lt;Image&gt; Images { get; set; }

        public bool IsQuotable
        {
            get
            {
                return true;
            }
        }

        public bool IsAvailable { get; set; }

        /// &lt;summary&gt;
        /// if the product is sold by subscription only this property contains the recurrence plan
        /// &lt;/summary&gt;
        public PaymentPlan PaymentPlan { get; set; }

        /// &lt;summary&gt;
        /// Apply prices to product
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;prices&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;currentCurrency&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;allCurrencies&quot;&gt;&lt;/param&gt;
        public void ApplyPrices(IEnumerable&lt;ProductPrice&gt; prices, Currency currentCurrency, IEnumerable&lt;Currency&gt; allCurrencies)
        {
            Prices.Clear();
            Price = null;

            Currency = currentCurrency;
            //group prices by currency
            var groupByCurrencyPrices = prices.GroupBy(x =&gt; x.Currency).Where(x =&gt; x.Any());
            foreach (var currencyGroup in groupByCurrencyPrices)
            {
                //For each currency need get nominal price (with min qty)
                var orderedPrices = currencyGroup.OrderBy(x =&gt; x.MinQuantity ?? 0).ThenBy(x =&gt; x.ListPrice);
                var nominalPrice = orderedPrices.FirstOrDefault();
                //and add to nominal price other prices as tier prices
                nominalPrice.TierPrices.AddRange(orderedPrices.Select(x =&gt; new TierPrice(x.SalePrice, x.MinQuantity ?? 1)));
                //Add nominal price to product prices list 
                Prices.Add(nominalPrice);
            }

            ApplyPricesWithExchangeRates(allCurrencies);

            //Set current product price for current currency
            Price = Prices.FirstOrDefault(x =&gt; x.Currency == currentCurrency);
        }

        private void ApplyPricesWithExchangeRates(IEnumerable&lt;Currency&gt; allCurrencies)
        {
            //Need add product price for all currencies (even if not returned from API need make it by currency exchange conversation)
            foreach (var currency in allCurrencies)
            {
                var price = Prices.FirstOrDefault(x =&gt; x.Currency == currency);
                if (price == null)
                {
                    price = new ProductPrice(currency);
                    //Convert exist price to new currency
                    if (Prices.Any())
                    {
                        price = Prices.First().ConvertTo(currency);
                        price.TierPrices.Add(new TierPrice(price.SalePrice, 1));
                    }
                    Prices.Add(price);
                }
            }
        }

        #region IHasProperties Members
        public IList&lt;CatalogProperty&gt; Properties { get; set; }
        #endregion

        #region ITaxable Members

        /// &lt;summary&gt;
        /// Gets or sets the value of total shipping tax amount
        /// &lt;/summary&gt;
        public Money TaxTotal
        {
            get
            {
                return Price != null ? Price.TaxTotal : null;
            }
        }

        public decimal TaxPercentRate
        {
            get
            {
                return Price != null ? Price.TaxPercentRate : 0m;
            }
        }

        /// &lt;summary&gt;
        /// Gets or sets the value of shipping tax type
        /// &lt;/summary&gt;
        public string TaxType { get; set; }

        /// &lt;summary&gt;
        /// Gets or sets the collection of line item tax details lines
        /// &lt;/summary&gt;
        /// &lt;value&gt;
        /// Collection of TaxDetail objects
        /// &lt;/value&gt;
        public IList&lt;TaxDetail&gt; TaxDetails { get; set; }

        public Money EmptiesDeposit { get; set; }

        public void ApplyTaxRates(IEnumerable&lt;TaxRate&gt; taxRates)
        {
            var productTaxRates = taxRates.Where(x =&gt; x.Line.Id != null &amp;&amp; x.Line.Id.EqualsInvariant(Id ?? &quot;&quot;));
            Price.ApplyTaxRates(productTaxRates);
        }

        #endregion

        #region IDiscountable Members
        public IList&lt;Discount&gt; Discounts { get; private set; }

        public Currency Currency { get; set; }

        public void ApplyRewards(IEnumerable&lt;PromotionReward&gt; rewards)
        {
            var productRewards = rewards.Where(r =&gt; r.RewardType == PromotionRewardType.CatalogItemAmountReward &amp;&amp; (r.ProductId.IsNullOrEmpty() || r.ProductId.EqualsInvariant(Id)));
            if (productRewards == null)
            {
                return;
            }

            Discounts.Clear();
            Price.DiscountAmount = new Money(Math.Max(0, (Price.ListPrice - Price.SalePrice).Amount), Currency);

            foreach (var reward in productRewards)
            {
                //Initialize tier price discount amount by default values
                var discount = reward.ToDiscountModel(Price.ListPrice - Price.DiscountAmount);
                foreach (var tierPrice in Price.TierPrices)
                {
                    tierPrice.DiscountAmount = new Money(Math.Max(0, (Price.ListPrice - tierPrice.Price).Amount), Currency);
                }

                if (reward.IsValid)
                {
                    Discounts.Add(discount);
                    Price.DiscountAmount += discount.Amount;

                    //apply discount to tier prices
                    foreach (var tierPrice in Price.TierPrices)
                    {
                        discount = reward.ToDiscountModel(tierPrice.Price - tierPrice.DiscountAmount);
                        tierPrice.DiscountAmount += discount.Amount;
                    }
                }
            }
        }

        #endregion



        public override string ToString()
        {
            return string.Format(CultureInfo.InvariantCulture, &quot;product #{0} sku: {1} name: {2}&quot;, Id ?? &quot;undef&quot;, Sku ?? &quot;undef&quot;, Name ?? &quot;undef&quot;);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[13,9,13,25,1],[14,9,14,10,1],[15,13,15,54,1],[16,13,16,63,1],[17,13,17,47,1],[18,13,18,40,1],[19,13,19,46,1],[20,13,20,40,1],[21,13,21,56,1],[22,13,22,46,1],[23,13,23,52,1],[24,13,24,48,1],[25,9,25,10,1],[28,15,28,21,0],[29,9,29,10,0],[30,13,30,33,0],[31,13,31,48,0],[32,9,32,10,0],[37,48,37,52,0],[37,53,37,57,0],[42,30,42,34,0],[42,35,42,39,0],[47,29,47,33,0],[47,34,47,38,0],[52,30,52,34,0],[52,35,52,39,0],[57,35,57,39,0],[57,40,57,44,0],[62,36,62,40,0],[62,41,62,45,0],[67,33,67,37,0],[67,38,67,42,0],[71,33,71,37,0],[71,38,71,42,0],[75,29,75,33,0],[75,34,75,38,0],[79,41,79,45,0],[79,46,79,50,0],[84,39,84,43,0],[84,44,84,48,0],[89,33,89,37,0],[89,38,89,42,0],[94,33,94,37,0],[94,38,94,42,0],[99,32,99,36,0],[99,37,99,41,0],[104,38,104,42,0],[104,43,104,47,0],[109,34,109,38,0],[109,39,109,43,0],[114,34,114,38,0],[114,39,114,43,0],[119,37,119,41,0],[119,42,119,46,0],[124,36,124,40,0],[124,41,124,45,0],[129,34,129,38,0],[129,39,129,43,0],[134,37,134,41,0],[134,42,134,46,0],[139,34,139,38,1],[139,39,139,43,1],[144,39,144,43,1],[144,44,144,48,1],[149,37,149,41,0],[149,42,149,46,0],[154,34,154,38,0],[154,39,154,43,0],[159,34,159,38,0],[159,39,159,43,0],[164,33,164,37,0],[164,38,164,42,0],[169,36,169,40,0],[169,41,169,45,0],[174,46,174,50,0],[174,51,174,55,0],[179,47,179,51,0],[179,52,179,56,0],[184,38,184,42,0],[184,43,184,47,0],[189,40,189,44,0],[189,45,189,49,0],[194,38,194,42,0],[194,43,194,47,0],[196,34,196,38,0],[196,39,196,43,0],[201,32,201,36,0],[201,37,201,41,0],[206,61,206,65,0],[206,66,206,70,1],[211,38,211,42,0],[211,43,211,47,1],[216,44,216,48,0],[216,49,216,53,1],[221,50,221,54,0],[221,55,221,59,1],[226,37,226,41,0],[226,42,226,46,0],[231,54,231,58,0],[231,59,231,63,1],[236,37,236,41,0],[236,42,236,46,0],[241,45,241,49,0],[241,50,241,54,1],[246,55,246,59,0],[246,60,246,64,0],[251,65,251,69,0],[251,70,251,74,0],[256,13,256,14,0],[257,17,257,33,0],[259,17,259,60,0],[260,17,260,18,0],[261,21,261,28,0],[261,30,261,43,0],[261,44,261,46,0],[261,47,261,59,0],[262,21,262,22,0],[263,25,263,119,0],[264,21,264,22,0],[265,17,265,18,0],[266,17,266,31,0],[267,13,267,14,0],[273,34,273,38,0],[273,39,273,43,0],[278,37,278,41,0],[278,42,278,46,0],[283,38,283,42,0],[283,43,283,47,1],[288,13,288,14,0],[289,17,289,29,0],[290,13,290,14,0],[293,35,293,39,0],[293,40,293,44,0],[298,42,298,46,0],[298,47,298,51,0],[307,9,307,10,0],[308,13,308,28,0],[309,13,309,26,0],[311,13,311,40,0],[313,13,313,93,0],[313,61,313,71,0],[313,84,313,91,0],[314,13,314,20,0],[314,22,314,39,0],[314,40,314,42,0],[314,43,314,64,0],[315,13,315,14,0],[317,17,317,109,0],[317,64,317,82,0],[317,96,317,107,0],[318,17,318,67,0],[320,17,320,125,0],[320,76,320,122,0],[322,17,322,42,0],[323,13,323,14,0],[325,13,325,57,0],[328,13,328,79,0],[328,48,328,77,0],[329,9,329,10,0],[332,9,332,10,0],[334,13,334,20,0],[334,22,334,34,0],[334,35,334,37,0],[334,38,334,51,0],[335,13,335,14,0],[336,17,336,80,0],[336,56,336,78,0],[337,17,337,35,0],[338,17,338,18,0],[339,21,339,56,0],[341,21,341,38,0],[342,21,342,22,0],[343,25,343,68,0],[344,25,344,81,0],[345,21,345,22,0],[346,21,346,39,0],[347,17,347,18,0],[348,13,348,14,0],[349,9,349,10,0],[352,52,352,56,0],[352,57,352,61,1],[363,13,363,14,0],[364,17,364,62,0],[365,13,365,14,0],[371,13,371,14,0],[372,17,372,66,0],[373,13,373,14,0],[379,33,379,37,0],[379,38,379,42,0],[387,46,387,50,0],[387,51,387,55,1],[389,39,389,43,0],[389,44,389,48,0],[392,9,392,10,0],[393,13,393,113,0],[393,55,393,111,0],[394,13,394,50,0],[395,9,395,10,0],[400,44,400,48,0],[400,49,400,61,1],[402,36,402,40,0],[402,41,402,45,0],[405,9,405,10,0],[406,13,406,182,0],[406,53,406,180,0],[407,13,407,40,0],[408,13,408,14,0],[409,17,409,24,0],[412,13,412,31,0],[413,13,413,113,0],[415,13,415,20,0],[415,22,415,32,0],[415,33,415,35,0],[415,36,415,50,0],[416,13,416,14,0],[418,17,418,95,0],[419,17,419,24,0],[419,26,419,39,0],[419,40,419,42,0],[419,43,419,59,0],[420,17,420,18,0],[421,21,421,125,0],[422,17,422,18,0],[424,17,424,36,0],[425,17,425,18,0],[426,21,426,45,0],[427,21,427,61,0],[430,21,430,28,0],[430,30,430,43,0],[430,44,430,46,0],[430,47,430,63,0],[431,21,431,22,0],[432,25,432,103,0],[433,25,433,69,0],[434,21,434,22,0],[435,17,435,18,0],[436,13,436,14,0],[437,9,437,10,0],[444,9,444,10,0],[445,13,445,147,0],[446,9,446,10,0]]);
    </script>
  </body>
</html>